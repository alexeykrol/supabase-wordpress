# üîê Changelog v0.3.1 - Security Update

**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** 2025-10-05
**–¢–∏–ø:** Security & Maintenance Update
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï SECURITY –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. ‚úÖ CSRF Protection
**–ü—Ä–æ–±–ª–µ–º–∞:** REST API endpoint `/wp-json/supabase-auth/callback` –ø—Ä–∏–Ω–∏–º–∞–ª –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±–æ–≥–æ –¥–æ–º–µ–Ω–∞
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ Origin/Referer headers
**–§–∞–π–ª:** `supabase-bridge.php:57-68`

```php
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç —Å –Ω–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞
if ($origin && strpos($origin, parse_url($site_url, PHP_URL_HOST)) === false) {
  return new \WP_Error('csrf', 'Invalid origin', ['status'=>403]);
}
```

---

### 2. ‚úÖ JWT Audience Validation
**–ü—Ä–æ–±–ª–µ–º–∞:** JWT —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏–Ω–∏–º–∞–ª–∏—Å—å –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ `aud` claim
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `aud === 'authenticated'`
**–§–∞–π–ª:** `supabase-bridge.php:101`

```php
if (($claims['aud'] ?? '') !== 'authenticated') throw new Exception('Bad aud');
```

---

### 3. ‚úÖ Mandatory Email Verification
**–ü—Ä–æ–±–ª–µ–º–∞:** Email verification –±—ã–ª –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `email_verified === true`
**–§–∞–π–ª:** `supabase-bridge.php:86-88`

```php
if (($claims['email_verified'] ?? false) !== true) {
  throw new Exception('Email not verified');
}
```

**‚ö†Ô∏è BREAKING CHANGE:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ë–ï–ó –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–≥–æ email –ù–ï —Å–º–æ–≥—É—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è

---

### 4. ‚úÖ Open Redirect Protection
**–ü—Ä–æ–±–ª–µ–º–∞:** URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `?thank_you=` –∏ referrer –Ω–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª–∏—Å—å
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `isSafeRedirect()` - —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ same-origin URLs
**–§–∞–π–ª:** `auth-form.html:852-866`

```javascript
function isSafeRedirect(url) {
  if (url.startsWith('/')) return true; // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ OK
  const urlObj = new URL(url, window.location.origin);
  return urlObj.origin === window.location.origin; // –¢–æ–ª—å–∫–æ —Å–≤–æ–π –¥–æ–º–µ–Ω
}
```

---

## ‚ö° PERFORMANCE –£–õ–£–ß–®–ï–ù–ò–Ø

### 5. ‚úÖ JWKS Caching
**–ü—Ä–æ–±–ª–µ–º–∞:** JWKS –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** WordPress transients –∫–µ—à –Ω–∞ 1 —á–∞—Å
**–§–∞–π–ª:** `supabase-bridge.php:70-93`

```php
$cache_key = 'sb_jwks_' . md5($jwks);
$keys = get_transient($cache_key);
if ($keys === false) {
  // Fetch from Supabase
  set_transient($cache_key, $keys, 3600); // 1 hour cache
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Supabase, –±—ã—Å—Ç—Ä–µ–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

---

### 6. ‚úÖ Rate Limiting
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç brute force –∞—Ç–∞–∫
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 10 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 60 —Å–µ–∫—É–Ω–¥ –ø–æ IP
**–§–∞–π–ª:** `supabase-bridge.php:46-55`

```php
$attempts = get_transient($rate_key) ?: 0;
if ($attempts >= 10) {
  return new \WP_Error('rate_limit', 'Too many requests...', ['status'=>429]);
}
set_transient($rate_key, $attempts + 1, 60);
```

---

## üõ†Ô∏è MAINTENANCE –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 7. ‚úÖ Hardcoded Domains Removed
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–º–µ–Ω—ã questtales.com –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –∫–æ–¥–µ
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `window.location.origin`
**–§–∞–π–ª—ã:** `button.html`, `htmlblock.html`, `supabase-bridge.php`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–ª–∞–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º –¥–æ–º–µ–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

### 8. ‚úÖ PHP Version Requirement
**–ü—Ä–æ–±–ª–µ–º–∞:** `composer.json` —Ç—Ä–µ–±–æ–≤–∞–ª PHP >=7.4
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ PHP >=8.0
**–§–∞–π–ª:** `composer.json:6`

```json
"require": {
  "php": ">=8.0",
  "firebase/php-jwt": "^6.10"
}
```

---

### 9. ‚úÖ Git Security (.gitignore)
**–ü—Ä–æ–±–ª–µ–º–∞:** wp-config —Ñ–∞–π–ª—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏ –º–æ–≥–ª–∏ –ø–æ–ø–∞—Å—Ç—å –≤ Git
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω `.gitignore` —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
**–§–∞–π–ª:** `.gitignore` (–Ω–æ–≤—ã–π)

```gitignore
wp-config_questtales.php
wp-config_alexeykrol.php
wp-config*.php
.env
.env.local
```

---

## üì¶ –°–¢–†–£–ö–¢–£–†–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### ‚ùå –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã:
- `button.html` - –ø—Ä–æ—Å—Ç–∞—è –∫–Ω–æ–ø–∫–∞ (–¥—É–±–ª–∏—Ä–æ–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- `htmlblock.html` - callback handler (auth-form.html —Å–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback)

### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
- `supabase-bridge.php` - Admin UI —Ç–µ–ø–µ—Ä—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç auth-form.html
- –£–±—Ä–∞–Ω—ã —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–π `/supabase-callback/` —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ redirect URLs –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üß™ –ß–¢–û –¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ü–û–°–õ–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:
- [ ] **Google OAuth** ‚Üí –ª–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- [ ] **Facebook OAuth** ‚Üí –ª–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- [ ] **Magic Link** ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ ‚Üí –ª–æ–≥–∏–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- [ ] **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/registr/` ‚úÖ
- [ ] **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ referrer ‚úÖ

### Security —Ç–µ—Å—Ç—ã:
- [ ] –ü–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏–Ω–∞ 11 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Üí –ø–æ–ª—É—á–∏—Ç—å HTTP 429 (rate limit)
- [ ] URL –ø–∞—Ä–∞–º–µ—Ç—Ä `?thank_you=https://evil.com` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è default
- [ ] JWT –±–µ–∑ `aud` claim ‚Üí –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ `email_verified` ‚Üí –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è

---

## ‚ö†Ô∏è BREAKING CHANGES

### 1. Email Verification —Ç–µ–ø–µ—Ä—å –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù
**–°—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** –ï—Å–ª–∏ `email_verified` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
**–ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** –ï—Å–ª–∏ `email_verified !== true` ‚Üí –±–ª–æ–∫–∏—Ä—É–µ–º

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
- –£–±–µ–¥–∏—Å—å —á—Ç–æ –≤ Supabase Dashboard –≤–∫–ª—é—á–µ–Ω email confirmation
- Google/Facebook OAuth –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `email_verified: true` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã - –ø—Ä–æ–≤–µ—Ä—å `console.log(session.user.email_verified)` –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 7
- **Security –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 9
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** ~150
- **–°—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** ~80
- **–£–¥–∞–ª–µ–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤:** 2

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å v0.3.0

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å auth-form.html:
1. –û–±–Ω–æ–≤–∏ `supabase-bridge.php` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –û–±–Ω–æ–≤–∏ `auth-form.html` –≤ Elementor HTML –≤–∏–¥–∂–µ—Ç–µ
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤ Supabase Dashboard:
   - Redirect URL = `https://yourdomain.com/login/` (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ñ–æ—Ä–º–æ–π)
   - –ù–ï `/supabase-callback/`
4. –¢–µ—Å—Ç–∏—Ä—É–π –≤—Å–µ 3 –º–µ—Ç–æ–¥–∞

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å—Ç–∞—Ä—ã–µ button.html + htmlblock.html:
**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ auth-form.html!**

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –í—Å–µ 3 –º–µ—Ç–æ–¥–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –£–º–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
- ‚úÖ –°–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback
- ‚úÖ Security fixes –≤—Å—Ç—Ä–æ–µ–Ω—ã

---

**–í–µ—Ä—Å–∏—è:** 0.3.1
**–î–∞—Ç–∞:** 2025-10-05
**–ê–≤—Ç–æ—Ä:** Alexey Krol + Claude Code
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** PRODUCTION READY üîê
