<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  Supabase Auth Form - Google + Facebook + Magic Link             ‚ïë
  ‚ïë  Version: 2.3 - Security Update (Open Redirect Protection)       ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  üìñ DOCUMENTATION: See docs/AUTH-FORM-REDIRECT-GUIDE.md

  üöÄ QUICK SETUP:
  1. Paste this code into WordPress page (HTML widget/block)
  2. Configure AUTH_CONFIG in <script> section below
  3. Done!

  üí° TIP: Use Settings page to configure Supabase credentials and pages
-->

<style>
  /* ========== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ========== */

  .sb-auth-wrapper {
    max-width: 440px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .sb-auth-card {
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    padding: 48px 40px;
    transition: box-shadow 0.3s ease;
  }

  .sb-auth-card:hover {
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1), 0 24px 48px rgba(0, 0, 0, 0.12);
  }

  /* ========== –ó–ê–ì–û–õ–û–í–û–ö ========== */

  .sb-auth-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .sb-auth-logo {
    font-size: 32px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 8px 0;
    letter-spacing: -0.5px;
  }

  .sb-auth-tagline {
    font-size: 15px;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
  }

  /* ========== –≠–ö–†–ê–ù–´ ========== */

  .sb-screen {
    display: none;
  }

  .sb-screen.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ========== –ö–ù–û–ü–ö–ò OAUTH ========== */

  .sb-oauth-section {
    margin-bottom: 24px;
  }

  .sb-oauth-btn {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    background: #ffffff;
    font-size: 15px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-family: inherit;
  }

  .sb-oauth-btn:last-child {
    margin-bottom: 0;
  }

  .sb-oauth-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .sb-oauth-btn:active {
    transform: translateY(0);
  }

  .sb-oauth-icon {
    width: 20px;
    height: 20px;
  }

  /* ========== –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ ========== */

  .sb-divider {
    display: flex;
    align-items: center;
    margin: 24px 0;
    color: #9ca3af;
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .sb-divider::before,
  .sb-divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid #e5e7eb;
  }

  .sb-divider::before {
    margin-right: 16px;
  }

  .sb-divider::after {
    margin-left: 16px;
  }

  /* ========== EMAIL INPUT ========== */

  .sb-email-section {
    margin-bottom: 16px;
  }

  .sb-email-input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    font-size: 15px;
    color: #111827;
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: inherit;
  }

  .sb-email-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .sb-email-input::placeholder {
    color: #9ca3af;
  }

  /* ========== –ö–ù–û–ü–ö–ò ========== */

  .sb-btn {
    width: 100%;
    padding: 14px 16px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .sb-btn-primary {
    background: #111827;
    color: #ffffff;
  }

  .sb-btn-primary:hover {
    background: #1f2937;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .sb-btn-primary:active {
    transform: translateY(0);
  }

  .sb-btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  /* ========== CHECK EMAIL SCREEN ========== */

  .sb-check-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sb-check-icon svg {
    width: 32px;
    height: 32px;
    color: #3b82f6;
  }

  .sb-check-title {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 12px 0;
    text-align: center;
  }

  .sb-check-text {
    font-size: 15px;
    color: #6b7280;
    text-align: center;
    line-height: 1.6;
    margin: 0 0 8px 0;
  }

  .sb-user-email {
    color: #111827;
    font-weight: 600;
  }

  .sb-check-instruction {
    font-size: 14px;
    color: #9ca3af;
    text-align: center;
    margin: 0 0 24px 0;
  }

  /* ========== CODE INPUT ========== */

  .sb-code-toggle {
    text-align: center;
    margin: 24px 0;
  }

  .sb-link {
    color: #3b82f6;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .sb-link:hover {
    color: #2563eb;
    text-decoration: underline;
  }

  .sb-code-section {
    display: none;
    margin-top: 24px;
  }

  .sb-code-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  .sb-code-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    text-align: center;
  }

  .sb-code-input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    font-size: 20px;
    color: #111827;
    text-align: center;
    letter-spacing: 6px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: 'Courier New', monospace;
  }

  .sb-code-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .sb-code-input::placeholder {
    color: #d1d5db;
    letter-spacing: 4px;
  }

  .sb-verify-btn {
    margin-top: 12px;
  }

  /* ========== FOOTER LINKS ========== */

  .sb-footer {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #6b7280;
  }

  /* ========== –°–û–û–ë–©–ï–ù–ò–Ø ========== */

  .sb-message {
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    margin-bottom: 16px;
    text-align: center;
    display: none;
  }

  .sb-message.active {
    display: block;
  }

  .sb-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    animation: shake 0.3s ease;
  }

  .sb-success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #16a34a;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  /* ========== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø ========== */

  @media (max-width: 480px) {
    .sb-auth-wrapper {
      padding: 16px;
    }

    .sb-auth-card {
      padding: 40px 28px;
      border-radius: 16px;
    }

    .sb-auth-logo {
      font-size: 28px;
    }

    .sb-auth-tagline {
      font-size: 14px;
    }

    .sb-oauth-btn,
    .sb-email-input,
    .sb-btn {
      padding: 12px 14px;
      font-size: 14px;
    }

    .sb-check-icon {
      width: 56px;
      height: 56px;
      margin-bottom: 20px;
    }

    .sb-check-icon svg {
      width: 28px;
      height: 28px;
    }

    .sb-check-title {
      font-size: 22px;
    }

    .sb-check-text {
      font-size: 14px;
    }
  }

  @media (max-width: 360px) {
    .sb-auth-card {
      padding: 32px 24px;
    }

    .sb-auth-logo {
      font-size: 24px;
    }
  }
</style>

<!-- –§–û–†–ú–ê -->
<div class="sb-auth-wrapper">
  <div class="sb-auth-card">
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="sb-message sb-error" id="sb-error-msg"></div>
    <div class="sb-message sb-success" id="sb-success-msg"></div>

    <!-- ========== –≠–ö–†–ê–ù 1: EMAIL + OAUTH ========== -->
    <div class="sb-screen active" id="sb-screen-1">
      <!-- OAuth –∫–Ω–æ–ø–∫–∏ -->
      <div class="sb-oauth-section">
        <!-- Google -->
        <button class="sb-oauth-btn" id="sb-google-btn">
          <svg class="sb-oauth-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á–µ—Ä–µ–∑ Google
        </button>

        <!-- Facebook -->
        <button class="sb-oauth-btn" id="sb-facebook-btn">
          <svg class="sb-oauth-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" fill="#1877F2"/>
          </svg>
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á–µ—Ä–µ–∑ Facebook
        </button>
      </div>

      <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
      <div class="sb-divider">–∏–ª–∏</div>

      <!-- Email —Ñ–æ—Ä–º–∞ -->
      <form id="sb-email-form">
        <div class="sb-email-section">
          <input
            type="email"
            id="sb-email-input"
            class="sb-email-input"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"
            required
            autocomplete="email"
          >
        </div>
        <button type="submit" class="sb-btn sb-btn-primary">
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å email
        </button>
        <p style="text-align: center; font-size: 13px; color: #6b7280; margin-top: 12px; line-height: 1.5;">
          –í–∞–º –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –¥–ª—è –≤—Ö–æ–¥–∞, –∏ –≤–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —ç—Ç–æ –ø–∏—Å—å–º–æ –∏ –Ω–∞–∂–∞—Ç—å —Å—Å—ã–ª–∫—É. –ë–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –Ω–∏ –≤–æ–π—Ç–∏, –Ω–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.
        </p>
      </form>
    </div>

    <!-- ========== –≠–ö–†–ê–ù 2: CHECK EMAIL ========== -->
    <div class="sb-screen" id="sb-screen-2">
      <!-- –ò–∫–æ–Ω–∫–∞ -->
      <div class="sb-check-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>

      <!-- –¢–µ–∫—Å—Ç -->
      <h3 class="sb-check-title">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É</h3>
      <p class="sb-check-text">
        –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –Ω–∞<br>
        <span class="sb-user-email" id="sb-display-email">your@email.com</span>
      </p>
      <p class="sb-check-instruction">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–æ–ª—à–µ–±–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –ø–∏—Å—å–º–µ –¥–ª—è –≤—Ö–æ–¥–∞
      </p>

      <!-- –ö–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –°–ö–†–´–¢, –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º verification code -->
      <div class="sb-code-toggle" style="display: none;">
        <a class="sb-link" id="sb-show-code">–ï—Å—Ç—å –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è?</a>
      </div>

      <div class="sb-code-section" id="sb-code-section">
        <label class="sb-code-label" for="sb-code-input">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
        <input
          type="text"
          id="sb-code-input"
          class="sb-code-input"
          placeholder="000000"
          maxlength="6"
          pattern="[0-9]{6}"
          inputmode="numeric"
        >
        <button class="sb-btn sb-btn-primary sb-verify-btn" id="sb-verify-btn">
          –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email
        </button>
      </div>

      <!-- Footer -->
      <div class="sb-footer">
        <div style="margin-bottom: 16px;">
          <strong>–ù–µ –≤–∏–¥–∏—Ç–µ –ø–∏—Å—å–º–æ –≤–æ –≤—Ö–æ–¥—è—â–∏—Ö?</strong>
        </div>
        <div style="text-align: left; font-size: 14px; line-height: 1.8;">
          <strong>1.</strong> –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ email: <span id="sb-footer-email" style="font-weight: 600;"></span><br>
          –ï—Å–ª–∏ –∞–¥—Ä–µ—Å —É–∫–∞–∑–∞–Ω —Å –æ—à–∏–±–∫–æ–π, <a class="sb-link" id="sb-back-to-form">–≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å</a><br><br>

          <strong>2.</strong> –ï—Å–ª–∏ –∞–¥—Ä–µ—Å —É–∫–∞–∑–∞–Ω –≤–µ—Ä–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫–∏ <strong>–°–ø–∞–º</strong>, <strong>–ü—Ä–æ–º–æ</strong>, <strong>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</strong>, 99% –ø–∏—Å—å–º–∞ —Ç–∞–º.<br><br>

          <strong>3.</strong> –ï—Å–ª–∏ –ø–∏—Å—å–º–∞ –Ω–µ—Ç, <a class="sb-link" id="sb-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ Supabase SDK (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–ª–∞–≥–∏–Ω–æ–º) -->
<script>
  // window.SUPABASE_CFG —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ø–ª–∞–≥–∏–Ω–æ–º —á–µ—Ä–µ–∑ wp_enqueue_scripts
  // window.supabase —Ç–æ–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ø–ª–∞–≥–∏–Ω–æ–º
</script>

<script>
  // ========== SUPABASE AUTH –° –£–ú–ù–´–ú–ò –†–ï–î–ò–†–ï–ö–¢–ê–ú–ò ==========

  (function() {
    'use strict';

    // ========== SAFE LOCALSTORAGE WRAPPER (Safari Privacy Protection) ==========
    // Safari —Å Enhanced Privacy Protection –±–ª–æ–∫–∏—Ä—É–µ—Ç localStorage
    // –≠—Ç–æ—Ç wrapper –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç fallback –Ω–∞ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    const safeStorage = (function() {
      let memoryStorage = {}; // Fallback –¥–ª—è Safari Privacy mode
      let storageAvailable = false;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ localStorage
      try {
        const testKey = '__storage_test__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        storageAvailable = true;
        console.log('‚úÖ localStorage –¥–æ—Å—Ç—É–ø–µ–Ω');
      } catch (e) {
        console.warn('‚ö†Ô∏è  localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Safari Privacy Protection, –∏—Å–ø–æ–ª—å–∑—É–µ–º in-memory fallback');
        storageAvailable = false;
      }

      return {
        getItem: function(key) {
          try {
            return storageAvailable ? localStorage.getItem(key) : memoryStorage[key] || null;
          } catch (e) {
            return memoryStorage[key] || null;
          }
        },
        setItem: function(key, value) {
          try {
            if (storageAvailable) {
              localStorage.setItem(key, value);
            } else {
              memoryStorage[key] = value;
            }
          } catch (e) {
            memoryStorage[key] = value;
          }
        },
        removeItem: function(key) {
          try {
            if (storageAvailable) {
              localStorage.removeItem(key);
            } else {
              delete memoryStorage[key];
            }
          } catch (e) {
            delete memoryStorage[key];
          }
        },
        key: function(index) {
          try {
            return storageAvailable ? localStorage.key(index) : Object.keys(memoryStorage)[index] || null;
          } catch (e) {
            return Object.keys(memoryStorage)[index] || null;
          }
        },
        get length() {
          try {
            return storageAvailable ? localStorage.length : Object.keys(memoryStorage).length;
          } catch (e) {
            return Object.keys(memoryStorage).length;
          }
        }
      };
    })();
    // ========== END SAFE LOCALSTORAGE WRAPPER ==========

    // ========== CLEANUP: Clear Supabase session BEFORE form loads ==========
    // This ensures fresh login state every time user visits login page
    (function cleanupSupabaseSession() {
      try {
        // Clear all Supabase localStorage keys
        const keysToRemove = [];
        for (let i = 0; i < safeStorage.length; i++) {
          const key = safeStorage.key(i);
          if (key && (key.startsWith('sb-') || key.startsWith('sb_processed_'))) {
            keysToRemove.push(key);
          }
        }

        if (keysToRemove.length > 0) {
          console.log('üßπ Cleaning up Supabase localStorage before login:', keysToRemove.length, 'keys');
          keysToRemove.forEach(key => safeStorage.removeItem(key));
          console.log('‚úÖ Supabase localStorage cleared - ready for fresh login');
        }
      } catch (e) {
        console.warn('Could not clean localStorage:', e);
      }
    })();
    // ========== END CLEANUP ==========

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–ø—É—Å–∫–∞ –µ—Å–ª–∏ DOM –Ω–µ –≥–æ—Ç–æ–≤
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAuthForm);
    } else {
      initAuthForm();
    }

    function initAuthForm() {
      try {
        // ========== SAVE RETURN URL FOR LOGIN FLOW ==========
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞)
        const returnUrl = document.referrer || window.location.origin + '/';
        console.log('üîó Login return URL detected:', returnUrl);
        safeStorage.setItem('login_return_url', returnUrl);

        // ========== SAVE REGISTRATION PAGE URL FOR REGISTRATION PAIRS ==========
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏) –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Thank You page
        const registrationPageUrl = window.location.pathname;
        console.log('üìù Registration page URL:', registrationPageUrl);
        safeStorage.setItem('registration_page_url', registrationPageUrl);

        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========

        const AUTH_CONFIG = {
      // üéØ –ù–ê–°–¢–†–û–ô–ö–ê –°–¢–†–ê–ù–ò–¶ –ë–õ–ê–ì–û–î–ê–†–ù–û–°–¢–ò –î–õ–Ø –ù–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
      //
      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑):
      // 1. URL –ø–∞—Ä–∞–º–µ—Ç—Ä ?thank_you=/custom-page/  (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—Å—ë)
      // 2. Mapping –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª (referrer)
      // 3. Default —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (fallback)
      //
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –†–ï–ñ–ò–ú 1 - –°–¢–ê–ù–î–ê–†–¢–ù–´–ô (–æ–¥–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≤—Å–µ—Ö):
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // thankYouPages: {
      //   'default': '/thank-you/'
      // }
      //
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –†–ï–ñ–ò–ú 2 - –ü–ê–†–ù–´–ô (—Ä–∞–∑–Ω—ã–µ thank-you –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª–µ–Ω–¥–∏–Ω–≥–æ–≤):
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // thankYouPages: {
      //   '/landing-premium/': '/thank-you-premium/',
      //   '/landing-basic/': '/thank-you-basic/',
      //   '/webinar/': '/thank-you-webinar/',
      //   'default': '/thank-you/'
      // }
      //
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –†–ï–ñ–ò–ú 3 - –ì–ò–ë–ö–ò–ô (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ URL):
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –ù–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–º–µ—Ç—Ä:
      // <a href="/auth/?thank_you=/special-thank-you/">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      //
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –¢–ï–ö–£–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò (–†–µ–∂–∏–º 2 - –ø–∞—Ä–Ω—ã–π):
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      thankYouPages: {
        'default': window.SUPABASE_CFG?.thankYouUrl || '/registr/'  // Thank You Page from Settings
      },

      // üè† –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏)
      defaultRedirect: '/',

      // ‚è±Ô∏è –ü–æ—Ä–æ–≥ "–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (60 —Å–µ–∫ = –Ω–µ–¥–∞–≤–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
      newUserThreshold: 60000
    };

    // ========== –≠–õ–ï–ú–ï–ù–¢–´ DOM ==========

    const screen1 = document.getElementById('sb-screen-1');
    const screen2 = document.getElementById('sb-screen-2');
    const emailForm = document.getElementById('sb-email-form');
    const emailInput = document.getElementById('sb-email-input');
    const displayEmail = document.getElementById('sb-display-email');
    const googleBtn = document.getElementById('sb-google-btn');
    const facebookBtn = document.getElementById('sb-facebook-btn');
    const showCodeBtn = document.getElementById('sb-show-code');
    const codeSection = document.getElementById('sb-code-section');
    const codeInput = document.getElementById('sb-code-input');
    const verifyBtn = document.getElementById('sb-verify-btn');
    const backToFormBtn = document.getElementById('sb-back-to-form');
    const resendBtn = document.getElementById('sb-resend');
    const errorMsg = document.getElementById('sb-error-msg');
    const successMsg = document.getElementById('sb-success-msg');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
    const requiredElements = {
      screen1, screen2, emailForm, emailInput, displayEmail,
      googleBtn, facebookBtn, showCodeBtn, codeSection, codeInput,
      verifyBtn, resendBtn, errorMsg, successMsg
    };

    for (const [name, element] of Object.entries(requiredElements)) {
      if (!element) {
        console.error(`‚ùå Supabase Auth Form: Required element '${name}' not found!`);
        console.log('üí° Make sure the HTML structure is complete');
        return; // –í—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–∫–∏ —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
      }
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SUPABASE ==========

    let supabaseClient;
    let isInitialized = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

    function initSupabase() {
      // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
      if (isInitialized) {
        console.log('‚ö†Ô∏è Supabase already initialized, skipping');
        return true;
      }

      if (!window.SUPABASE_CFG || !window.supabase) {
        return false;
      }

      try {
        const { createClient } = window.supabase;
        supabaseClient = createClient(
          window.SUPABASE_CFG.url,
          window.SUPABASE_CFG.anon
        );

        isInitialized = true; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        console.log('‚úÖ Supabase Auth initialized');
        return true;
      } catch (error) {
        console.error('Supabase init error:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Supabase');
        return false;
      }
    }

    // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å retry
    function waitForSupabase(callback, maxAttempts = 20) {
      let attempts = 0;

      const checkAndInit = () => {
        attempts++;

        if (window.SUPABASE_CFG && window.supabase) {
          // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞
          if (initSupabase()) {
            callback();
          } else {
            showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
          }
        } else if (attempts >= maxAttempts) {
          // –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
          showError('Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ wp-config.php –∏–ª–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–ª–∞–≥–∏–Ω–∞.');
          console.error('‚ùå SUPABASE_CFG not found after', maxAttempts, 'attempts');
          console.log('üí° Make sure supabase-bridge plugin is activated and wp-config.php is configured');
        } else {
          // –ü—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ 100ms
          setTimeout(checkAndInit, 100);
        }
      };

      checkAndInit();
    }

    // ========== TELEMETRY (v0.10.2) ==========
    // Async tracking to Supabase - zero impact on auth flow
    function trackTelemetry(event, data) {
      try {
        if (!window.SUPABASE_CFG) return; // Supabase not configured

        const payload = JSON.stringify({
          event: event,
          created_at: new Date().toISOString(),
          user_agent: navigator.userAgent.substring(0, 200),
          referrer: document.referrer || null,
          registration_url: window.location.pathname,
          landing_url: LANDING_URL || null,
          ...data
        });

        const url = window.SUPABASE_CFG.url + '/rest/v1/auth_telemetry';
        const headers = {
          'apikey': window.SUPABASE_CFG.anon,
          'Authorization': 'Bearer ' + window.SUPABASE_CFG.anon,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        };

        // Use fetch with keepalive (non-blocking, works even on page close)
        // Note: sendBeacon doesn't support custom headers, so we use fetch instead
        fetch(url, {
          method: 'POST',
          headers: headers,
          body: payload,
          keepalive: true
        }).catch(() => {}); // Silent fail - telemetry never breaks auth
      } catch (e) {
        // Silent fail - telemetry never breaks auth
      }
    }

    // ========== –£–¢–ò–õ–ò–¢–´ –†–ï–î–ò–†–ï–ö–¢–û–í ==========

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const ORIGIN_PAGE = (function() {
      const params = new URLSearchParams(window.location.search);

      // 1. Explicit –ø–∞—Ä–∞–º–µ—Ç—Ä redirect_to (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
      if (params.get('redirect_to')) {
        console.log('üéØ ORIGIN_PAGE: from ?redirect_to =', params.get('redirect_to'));
        return params.get('redirect_to');
      }

      // 2. Referrer (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª)
      if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω
          if (referrerUrl.origin === window.location.origin) {
            console.log('üéØ ORIGIN_PAGE: from referrer =', referrerUrl.pathname);
            return referrerUrl.pathname;
          }
        } catch (e) {
          console.warn('Invalid referrer:', e);
        }
      }

      // 3. Fallback - —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
      console.log('üéØ ORIGIN_PAGE: fallback (current page) =', window.location.pathname);
      return window.location.pathname;
    })();

    // ========== LANDING URL TRACKING (v0.10.0) ==========

    // Clean advertising tracking parameters from URL (fbclid, gclid, etc.)
    function cleanTrackingParams(url) {
      if (!url) return null;

      try {
        const urlObj = new URL(url, window.location.origin);
        const trackingParams = ['fbclid', 'gclid', 'msclkid', 'gbraid', 'wbraid'];

        trackingParams.forEach(param => {
          urlObj.searchParams.delete(param);
        });

        // Return pathname + clean search params
        return urlObj.pathname + urlObj.search;
      } catch (e) {
        console.warn('Failed to clean tracking params:', e);
        return url;
      }
    }

    // Save landing URL (where user first arrived) for marketing analytics
    const LANDING_URL = (function() {
      if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          // Only save if same domain
          if (referrerUrl.origin === window.location.origin) {
            const cleaned = cleanTrackingParams(document.referrer);
            console.log('üìä LANDING_URL (cleaned):', cleaned);
            return cleaned;
          } else {
            console.log('üìä LANDING_URL: external referrer, not tracking');
            return null;
          }
        } catch (e) {
          console.warn('Invalid landing referrer:', e);
          return null;
        }
      }

      // No referrer - user came directly to auth form
      console.log('üìä LANDING_URL: none (direct auth form access)');
      return null;
    })();

    // Security: Validate redirect URL to prevent open redirect attacks
    function isSafeRedirect(url) {
      if (!url) return false;

      // Allow relative paths (start with /)
      if (url.startsWith('/')) return true;

      // Check if URL is on same domain
      try {
        const urlObj = new URL(url, window.location.origin);
        return urlObj.origin === window.location.origin;
      } catch (e) {
        console.warn('Invalid redirect URL:', url);
        return false;
      }
    }

    function getReturnUrl() {
      // –ï—Å–ª–∏ origin page = —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º defaultRedirect (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å loop)
      if (ORIGIN_PAGE === window.location.pathname) {
        console.log('‚ö†Ô∏è ORIGIN_PAGE is current page, using defaultRedirect');
        return AUTH_CONFIG.defaultRedirect;
      }
      // –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏
      // Security: validate before returning
      if (!isSafeRedirect(ORIGIN_PAGE)) {
        console.warn('‚ö†Ô∏è Unsafe redirect detected, using defaultRedirect');
        return AUTH_CONFIG.defaultRedirect;
      }
      return ORIGIN_PAGE;
    }

    function getThankYouPage() {
      const params = new URLSearchParams(window.location.search);

      // 1. Explicit –ø–∞—Ä–∞–º–µ—Ç—Ä thank_you (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
      const customPage = params.get('thank_you');
      if (customPage) {
        // Security: validate custom page parameter
        if (!isSafeRedirect(customPage)) {
          console.warn('‚ö†Ô∏è Unsafe thank_you parameter detected, using default');
          return AUTH_CONFIG.thankYouPages.default;
        }
        return customPage;
      }

      // === Phase 5: Use page-specific pairs from Settings ===
      // 2a. Check registration pairs from Settings (wp_options ‚Üí Supabase ‚Üí JavaScript)
      if (window.SUPABASE_CFG?.registrationPairs && Array.isArray(window.SUPABASE_CFG.registrationPairs)) {
        const pair = window.SUPABASE_CFG.registrationPairs.find(
          p => p.registration_url === ORIGIN_PAGE
        );

        if (pair && pair.thankyou_url) {
          console.log('‚úÖ Phase 5: Found pair for', ORIGIN_PAGE, '‚Üí', pair.thankyou_url);
          return pair.thankyou_url;
        }
      }

      // 2b. Fallback: Legacy hardcoded mapping (for backward compatibility)
      if (AUTH_CONFIG.thankYouPages[ORIGIN_PAGE]) {
        console.log('‚ö†Ô∏è Using legacy hardcoded mapping for', ORIGIN_PAGE);
        return AUTH_CONFIG.thankYouPages[ORIGIN_PAGE];
      }

      // 3. Default fallback (global Thank You Page from Settings)
      console.log('‚ÑπÔ∏è No specific pair found, using global default:', AUTH_CONFIG.thankYouPages.default);
      return AUTH_CONFIG.thankYouPages.default;
    }

    function isNewUser(user) {
      if (!user || !user.created_at) return false;

      const createdAt = new Date(user.created_at);
      const now = new Date();
      const diff = now - createdAt;

      return diff < AUTH_CONFIG.newUserThreshold;
    }

    // ========== EMAIL MAGIC LINK ==========

    let isEmailSubmitting = false;

    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();

      if (!email) return;

      if (!supabaseClient) {
        showError('Supabase –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
        return;
      }

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
      if (isEmailSubmitting) {
        console.log('‚ö†Ô∏è Already submitting, ignoring duplicate click');
        return;
      }

      console.log('üéØ User submitted email for magic link');

      try {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º loading
        isEmailSubmitting = true;
        const submitBtn = emailForm.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
          submitBtn.style.opacity = '0.6';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ magic link —Å registration_url + landing_url –≤ URL (—Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏)
        const currentPage = window.location.pathname;
        let callbackWithParam = '{{CALLBACK_URL}}?registration_url=' + encodeURIComponent(currentPage);

        // Add landing_url if available (v0.10.0 - marketing tracking)
        if (LANDING_URL) {
          callbackWithParam += '&landing_url=' + encodeURIComponent(LANDING_URL);
          console.log('üìä Magic Link includes landing_url:', LANDING_URL);
        }

        const { error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: callbackWithParam
          }
        });

        if (error) throw error;

        // Track telemetry: MagicLink requested (v0.10.2)
        trackTelemetry('magic_link_requested', {
          email: email,
          provider: 'magic_link'
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω 2 (—Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω –±–µ–∑ –º–∏–≥–∞–Ω–∏—è)
        displayEmail.textContent = email;

        // –ü–æ–∫–∞–∑–∞—Ç—å email –≤ footer –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        const footerEmail = document.getElementById('sb-footer-email');
        if (footerEmail) {
          footerEmail.textContent = email;
        }

        switchScreen(2);

      } catch (error) {
        console.error('Magic link error:', error);
        showError(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ª—à–µ–±–Ω—É—é —Å—Å—ã–ª–∫—É');

        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const submitBtn = emailForm.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          submitBtn.style.opacity = '1';
        }
        isEmailSubmitting = false;
      }
    });

    // ========== GOOGLE OAUTH ==========

    let isGoogleSubmitting = false;

    googleBtn.addEventListener('click', async () => {
      if (!supabaseClient) {
        showError('Supabase –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
        return;
      }

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
      if (isGoogleSubmitting) {
        console.log('‚ö†Ô∏è Google OAuth already in progress, ignoring duplicate click');
        return;
      }

      console.log('üéØ User clicked Google OAuth button');

      try {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        isGoogleSubmitting = true;
        const originalText = googleBtn.textContent;
        googleBtn.disabled = true;
        googleBtn.textContent = '–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...';
        googleBtn.style.opacity = '0.6';

        // Save landing_url to localStorage for OAuth flow (v0.10.0)
        if (LANDING_URL) {
          safeStorage.setItem('sb_landing_url', LANDING_URL);
          console.log('üìä Saved landing_url to localStorage for OAuth:', LANDING_URL);
        }

        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: '{{CALLBACK_URL}}'
          }
        });

        if (error) throw error;

        // Track telemetry: OAuth requested (v0.10.2)
        trackTelemetry('oauth_requested', {
          provider: 'google'
        });

        // –£—Å–ø–µ—Ö - –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ Google, –∫–Ω–æ–ø–∫—É –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º

      } catch (error) {
        console.error('OAuth error:', error);
        showError(error.message || '–û—à–∏–±–∫–∞ OAuth –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');

        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        googleBtn.disabled = false;
        googleBtn.textContent = originalText;
        googleBtn.style.opacity = '1';
        isGoogleSubmitting = false;
      }
    });

    // ========== FACEBOOK OAUTH ==========

    let isFacebookSubmitting = false;

    facebookBtn.addEventListener('click', async () => {
      if (!supabaseClient) {
        showError('Supabase –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
        return;
      }

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
      if (isFacebookSubmitting) {
        console.log('‚ö†Ô∏è Facebook OAuth already in progress, ignoring duplicate click');
        return;
      }

      console.log('üéØ User clicked Facebook OAuth button');

      try {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        isFacebookSubmitting = true;
        const originalText = facebookBtn.textContent;
        facebookBtn.disabled = true;
        facebookBtn.textContent = '–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...';
        facebookBtn.style.opacity = '0.6';

        // Save landing_url to localStorage for OAuth flow (v0.10.0)
        if (LANDING_URL) {
          safeStorage.setItem('sb_landing_url', LANDING_URL);
          console.log('üìä Saved landing_url to localStorage for OAuth:', LANDING_URL);
        }

        const { error} = await supabaseClient.auth.signInWithOAuth({
          provider: 'facebook',
          options: {
            redirectTo: '{{CALLBACK_URL}}',
            scopes: 'email public_profile'
          }
        });

        if (error) throw error;

        // Track telemetry: OAuth requested (v0.10.2)
        trackTelemetry('oauth_requested', {
          provider: 'facebook'
        });

        // –£—Å–ø–µ—Ö - –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ Facebook, –∫–Ω–æ–ø–∫—É –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º

      } catch (error) {
        console.error('OAuth error:', error);
        showError(error.message || '–û—à–∏–±–∫–∞ OAuth –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');

        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        facebookBtn.disabled = false;
        facebookBtn.textContent = originalText;
        facebookBtn.style.opacity = '1';
        isFacebookSubmitting = false;
      }
    });

    // ========== VERIFICATION CODE ==========

    showCodeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      codeSection.classList.add('active');
      showCodeBtn.style.display = 'none';
      codeInput.focus();
    });

    verifyBtn.addEventListener('click', async () => {
      const email = displayEmail.textContent;
      const code = codeInput.value.trim();

      if (code.length !== 6) {
        showError('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥');
        return;
      }

      if (!supabaseClient) {
        showError('Supabase –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
        return;
      }

      try {
        const { error } = await supabaseClient.auth.verifyOtp({
          email: email,
          token: code,
          type: 'email'
        });

        if (error) throw error;

      } catch (error) {
        console.error('Verification error:', error);
        showError(error.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
      }
    });

    // ========== BACK TO FORM (–Ω–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å) ==========

    // –ü—É–Ω–∫—Ç 1: –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
    if (backToFormBtn) {
      backToFormBtn.addEventListener('click', (e) => {
        e.preventDefault();
        switchScreen(1); // –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω 1 (—Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞)
        emailInput.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
        emailInput.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      });
    }

    // ========== RESEND (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ —Ç–æ—Ç –∂–µ –∞–¥—Ä–µ—Å) ==========

    // –ü—É–Ω–∫—Ç 3: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ —Ç–æ—Ç –∂–µ –∞–¥—Ä–µ—Å
    if (resendBtn) {
      resendBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = displayEmail.textContent;

        if (!supabaseClient) {
          showError('Supabase –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown (60 —Å–µ–∫—É–Ω–¥)
        const lastResendKey = 'sb_last_resend';
        const lastResend = localStorage.getItem(lastResendKey);
        const now = Date.now();

        if (lastResend && (now - parseInt(lastResend)) < 60000) {
          const remaining = Math.ceil((60000 - (now - parseInt(lastResend))) / 1000);
          showError(`–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${remaining} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π`);
          return;
        }

        try {
          // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
          const originalText = resendBtn.textContent;
          resendBtn.disabled = true;
          resendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
          resendBtn.style.opacity = '0.6';

          // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å —Ç–µ–º –∂–µ registration_url
          const currentPage = window.location.pathname;
          const callbackWithParam = '{{CALLBACK_URL}}?registration_url=' + encodeURIComponent(currentPage);

          const { error } = await supabaseClient.auth.signInWithOtp({
            email: email,
            options: {
              emailRedirectTo: callbackWithParam
            }
          });

          if (error) throw error;

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
          localStorage.setItem(lastResendKey, now.toString());

          showSuccess('‚úÖ –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –°–ê–ú–û–ï –ù–û–í–û–ï –ø–∏—Å—å–º–æ. –°—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.');

          // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä cooldown (60 —Å–µ–∫—É–Ω–¥)
          let countdown = 60;
          resendBtn.textContent = `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${countdown}—Å`;

          const timer = setInterval(() => {
            countdown--;
            if (countdown > 0) {
              resendBtn.textContent = `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${countdown}—Å`;
            } else {
              clearInterval(timer);
              resendBtn.textContent = originalText;
              resendBtn.disabled = false;
              resendBtn.style.opacity = '1';
            }
          }, 1000);

        } catch (error) {
          console.error('Resend error:', error);
          showError(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ');

          // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
          resendBtn.disabled = false;
          resendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â—ë —Ä–∞–∑';
          resendBtn.style.opacity = '1';
        }
      });
    }

    // ========== –£–¢–ò–õ–ò–¢–´ UI ==========

    function switchScreen(num) {
      screen1.classList.remove('active');
      screen2.classList.remove('active');

      if (num === 1) screen1.classList.add('active');
      if (num === 2) screen2.classList.add('active');
    }

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.add('active');
      setTimeout(() => errorMsg.classList.remove('active'), 5000);
    }

    function showSuccess(message) {
      successMsg.textContent = message;
      successMsg.classList.add('active');
      setTimeout(() => successMsg.classList.remove('active'), 3000);
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ SUPABASE_CFG –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
    waitForSupabase(() => {
      console.log('üéØ Ready to authenticate');
    });

    // ========== GLOBAL API ==========

    window.sbAuth = {
      switchScreen,
      showError,
      showSuccess,
      reset: () => {
        emailInput.value = '';
        codeInput.value = '';
        codeSection.classList.remove('active');
        showCodeBtn.style.display = '';
        switchScreen(1);
      },
      config: AUTH_CONFIG,
      client: supabaseClient
    };

      } catch (error) {
        console.error('‚ùå Supabase Auth Form initialization error:', error);
        console.log('üí° Check browser console for details');
        // –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ - –ø—É—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
      }
    } // end of initAuthForm()
  })(); // end of IIFE
</script>

<!--
  –ì–û–¢–û–í–û:
  ‚úÖ Supabase SDK –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
  ‚úÖ Magic Link (signInWithOtp)
  ‚úÖ Verification Code
  ‚úÖ Google OAuth
  ‚úÖ –£–º–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã (–Ω–æ–≤—ã–π vs —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
  ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ thank you pages
  ‚úÖ WordPress —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

  –ù–ê–°–¢–†–û–ô–ö–ê:
  –ò–∑–º–µ–Ω–∏ AUTH_CONFIG.thankYouPages –¥–ª—è —Å–≤–æ–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü!
-->