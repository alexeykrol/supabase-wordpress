<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  Supabase Auth Form - Google + Facebook + Magic Link             â•‘
  â•‘  Version: 2.3 - Security Update (Open Redirect Protection)       â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ğŸ“– DOCUMENTATION: See docs/AUTH-FORM-REDIRECT-GUIDE.md

  ğŸš€ QUICK SETUP:
  1. Paste this code into WordPress page (HTML widget/block)
  2. Configure AUTH_CONFIG in <script> section below
  3. Done!

  ğŸ’¡ TIP: Use Settings page to configure Supabase credentials and pages
-->

<style>
  /* ========== ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ  ========== */

  .sb-auth-wrapper {
    max-width: 440px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .sb-auth-card {
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    padding: 48px 40px;
    transition: box-shadow 0.3s ease;
  }

  .sb-auth-card:hover {
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1), 0 24px 48px rgba(0, 0, 0, 0.12);
  }

  /* ========== Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš ========== */

  .sb-auth-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .sb-auth-logo {
    font-size: 32px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 8px 0;
    letter-spacing: -0.5px;
  }

  .sb-auth-tagline {
    font-size: 15px;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
  }

  /* ========== Ğ­ĞšĞ ĞĞĞ« ========== */

  .sb-screen {
    display: none;
  }

  .sb-screen.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ========== ĞšĞĞĞŸĞšĞ˜ OAUTH ========== */

  .sb-oauth-section {
    margin-bottom: 24px;
  }

  .sb-oauth-btn {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    background: #ffffff;
    font-size: 15px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-family: inherit;
  }

  .sb-oauth-btn:last-child {
    margin-bottom: 0;
  }

  .sb-oauth-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .sb-oauth-btn:active {
    transform: translateY(0);
  }

  .sb-oauth-icon {
    width: 20px;
    height: 20px;
  }

  /* ========== Ğ ĞĞ—Ğ”Ğ•Ğ›Ğ˜Ğ¢Ğ•Ğ›Ğ¬ ========== */

  .sb-divider {
    display: flex;
    align-items: center;
    margin: 24px 0;
    color: #9ca3af;
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .sb-divider::before,
  .sb-divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid #e5e7eb;
  }

  .sb-divider::before {
    margin-right: 16px;
  }

  .sb-divider::after {
    margin-left: 16px;
  }

  /* ========== EMAIL INPUT ========== */

  .sb-email-section {
    margin-bottom: 16px;
  }

  .sb-email-input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    font-size: 15px;
    color: #111827;
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: inherit;
  }

  .sb-email-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .sb-email-input::placeholder {
    color: #9ca3af;
  }

  /* ========== ĞšĞĞĞŸĞšĞ˜ ========== */

  .sb-btn {
    width: 100%;
    padding: 14px 16px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .sb-btn-primary {
    background: #111827;
    color: #ffffff;
  }

  .sb-btn-primary:hover {
    background: #1f2937;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .sb-btn-primary:active {
    transform: translateY(0);
  }

  .sb-btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  /* ========== CHECK EMAIL SCREEN ========== */

  .sb-check-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sb-check-icon svg {
    width: 32px;
    height: 32px;
    color: #3b82f6;
  }

  .sb-check-title {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 12px 0;
    text-align: center;
  }

  .sb-check-text {
    font-size: 15px;
    color: #6b7280;
    text-align: center;
    line-height: 1.6;
    margin: 0 0 8px 0;
  }

  .sb-user-email {
    color: #111827;
    font-weight: 600;
  }

  .sb-check-instruction {
    font-size: 14px;
    color: #9ca3af;
    text-align: center;
    margin: 0 0 24px 0;
  }

  /* ========== CODE INPUT ========== */

  .sb-code-toggle {
    text-align: center;
    margin: 24px 0;
  }

  .sb-link {
    color: #3b82f6;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .sb-link:hover {
    color: #2563eb;
    text-decoration: underline;
  }

  .sb-code-section {
    display: none;
    margin-top: 24px;
  }

  .sb-code-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  .sb-code-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    text-align: center;
  }

  .sb-code-input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    font-size: 20px;
    color: #111827;
    text-align: center;
    letter-spacing: 6px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: 'Courier New', monospace;
  }

  .sb-code-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .sb-code-input::placeholder {
    color: #d1d5db;
    letter-spacing: 4px;
  }

  .sb-verify-btn {
    margin-top: 12px;
  }

  /* ========== FOOTER LINKS ========== */

  .sb-footer {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #6b7280;
  }

  /* ========== Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯ ========== */

  .sb-message {
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    margin-bottom: 16px;
    text-align: center;
    display: none;
  }

  .sb-message.active {
    display: block;
  }

  .sb-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    animation: shake 0.3s ease;
  }

  .sb-success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #16a34a;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  /* ========== ĞœĞĞ‘Ğ˜Ğ›Ğ¬ĞĞĞ¯ ĞĞ”ĞĞŸĞ¢ĞĞ¦Ğ˜Ğ¯ ========== */

  @media (max-width: 480px) {
    .sb-auth-wrapper {
      padding: 16px;
    }

    .sb-auth-card {
      padding: 40px 28px;
      border-radius: 16px;
    }

    .sb-auth-logo {
      font-size: 28px;
    }

    .sb-auth-tagline {
      font-size: 14px;
    }

    .sb-oauth-btn,
    .sb-email-input,
    .sb-btn {
      padding: 12px 14px;
      font-size: 14px;
    }

    .sb-check-icon {
      width: 56px;
      height: 56px;
      margin-bottom: 20px;
    }

    .sb-check-icon svg {
      width: 28px;
      height: 28px;
    }

    .sb-check-title {
      font-size: 22px;
    }

    .sb-check-text {
      font-size: 14px;
    }
  }

  @media (max-width: 360px) {
    .sb-auth-card {
      padding: 32px 24px;
    }

    .sb-auth-logo {
      font-size: 24px;
    }
  }
</style>

<!-- Ğ¤ĞĞ ĞœĞ -->
<div class="sb-auth-wrapper">
  <div class="sb-auth-card">
    <!-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ -->
    <div class="sb-message sb-error" id="sb-error-msg"></div>
    <div class="sb-message sb-success" id="sb-success-msg"></div>

    <!-- ========== Ğ­ĞšĞ ĞĞ 1: EMAIL + OAUTH ========== -->
    <div class="sb-screen active" id="sb-screen-1">
      <!-- OAuth ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ -->
      <div class="sb-oauth-section">
        <!-- Google -->
        <button class="sb-oauth-btn" id="sb-google-btn">
          <svg class="sb-oauth-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Continue with Google
        </button>

        <!-- Facebook -->
        <button class="sb-oauth-btn" id="sb-facebook-btn">
          <svg class="sb-oauth-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" fill="#1877F2"/>
          </svg>
          Continue with Facebook
        </button>
      </div>

      <!-- Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ -->
      <div class="sb-divider">or</div>

      <!-- Email Ñ„Ğ¾Ñ€Ğ¼Ğ° -->
      <form id="sb-email-form">
        <div class="sb-email-section">
          <input
            type="email"
            id="sb-email-input"
            class="sb-email-input"
            placeholder="Enter your email"
            required
            autocomplete="email"
          >
        </div>
        <button type="submit" class="sb-btn sb-btn-primary">
          Continue with email
        </button>
      </form>
    </div>

    <!-- ========== Ğ­ĞšĞ ĞĞ 2: CHECK EMAIL ========== -->
    <div class="sb-screen" id="sb-screen-2">
      <!-- Ğ˜ĞºĞ¾Ğ½ĞºĞ° -->
      <div class="sb-check-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>

      <!-- Ğ¢ĞµĞºÑÑ‚ -->
      <h3 class="sb-check-title">Check your email</h3>
      <p class="sb-check-text">
        To continue, click the link sent to<br>
        <span class="sb-user-email" id="sb-display-email">your@email.com</span>
      </p>
      <p class="sb-check-instruction">
        Click the magic link in the email to sign in
      </p>

      <!-- ĞšĞ¾Ğ´ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) -->
      <div class="sb-code-toggle">
        <a class="sb-link" id="sb-show-code">Have a verification code instead?</a>
      </div>

      <div class="sb-code-section" id="sb-code-section">
        <label class="sb-code-label" for="sb-code-input">Enter verification code</label>
        <input
          type="text"
          id="sb-code-input"
          class="sb-code-input"
          placeholder="000000"
          maxlength="6"
          pattern="[0-9]{6}"
          inputmode="numeric"
        >
        <button class="sb-btn sb-btn-primary sb-verify-btn" id="sb-verify-btn">
          Verify Email Address
        </button>
      </div>

      <!-- Footer -->
      <div class="sb-footer">
        Not seeing the email in your inbox? <a class="sb-link" id="sb-resend">Try sending again</a>
      </div>
    </div>
  </div>
</div>

<!-- Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Supabase SDK (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼) -->
<script>
  // window.SUPABASE_CFG ÑƒĞ¶Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼ Ñ‡ĞµÑ€ĞµĞ· wp_enqueue_scripts
  // window.supabase Ñ‚Ğ¾Ğ¶Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼
</script>

<script>
  // ========== SUPABASE AUTH Ğ¡ Ğ£ĞœĞĞ«ĞœĞ˜ Ğ Ğ•Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞœĞ˜ ==========

  (function() {
    'use strict';

    // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ĞµÑĞ»Ğ¸ DOM Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAuthForm);
    } else {
      initAuthForm();
    }

    function initAuthForm() {
      try {
        // ========== ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ==========

        const AUTH_CONFIG = {
      // ğŸ¯ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦ Ğ‘Ğ›ĞĞ“ĞĞ”ĞĞ ĞĞĞ¡Ğ¢Ğ˜ Ğ”Ğ›Ğ¯ ĞĞĞ’Ğ«Ğ¥ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ•Ğ™
      //
      // ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñ‹ (ÑĞ²ĞµÑ€Ñ…Ñƒ Ğ²Ğ½Ğ¸Ğ·):
      // 1. URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ ?thank_you=/custom-page/  (Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ²ÑÑ‘)
      // 2. Mapping Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ» (referrer)
      // 3. Default ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° (fallback)
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ Ğ•Ğ–Ğ˜Ğœ 1 - Ğ¡Ğ¢ĞĞĞ”ĞĞ Ğ¢ĞĞ«Ğ™ (Ğ¾Ğ´Ğ½Ğ° ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ²ÑĞµÑ…):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // thankYouPages: {
      //   'default': '/thank-you/'
      // }
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ Ğ•Ğ–Ğ˜Ğœ 2 - ĞŸĞĞ ĞĞ«Ğ™ (Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ thank-you Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ»ĞµĞ½Ğ´Ğ¸Ğ½Ğ³Ğ¾Ğ²):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // thankYouPages: {
      //   '/landing-premium/': '/thank-you-premium/',
      //   '/landing-basic/': '/thank-you-basic/',
      //   '/webinar/': '/thank-you-webinar/',
      //   'default': '/thank-you/'
      // }
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ Ğ•Ğ–Ğ˜Ğœ 3 - Ğ“Ğ˜Ğ‘ĞšĞ˜Ğ™ (Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· URL):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ĞĞ° Ğ»ĞµĞ½Ğ´Ğ¸Ğ½Ğ³Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€:
      // <a href="/auth/?thank_you=/special-thank-you/">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</a>
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ• ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ (Ğ ĞµĞ¶Ğ¸Ğ¼ 2 - Ğ¿Ğ°Ñ€Ğ½Ñ‹Ğ¹):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      thankYouPages: {
        'default': window.SUPABASE_CFG?.thankYouUrl || '/registr/'  // Thank You Page from Settings
      },

      // ğŸ  Ğ”Ğ»Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸)
      defaultRedirect: '/',

      // â±ï¸ ĞŸĞ¾Ñ€Ğ¾Ğ³ "Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ" Ğ² Ğ¼Ğ¸Ğ»Ğ»Ğ¸ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ… (60 ÑĞµĞº = Ğ½ĞµĞ´Ğ°Ğ²Ğ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½)
      newUserThreshold: 60000
    };

    // ========== Ğ­Ğ›Ğ•ĞœĞ•ĞĞ¢Ğ« DOM ==========

    const screen1 = document.getElementById('sb-screen-1');
    const screen2 = document.getElementById('sb-screen-2');
    const emailForm = document.getElementById('sb-email-form');
    const emailInput = document.getElementById('sb-email-input');
    const displayEmail = document.getElementById('sb-display-email');
    const googleBtn = document.getElementById('sb-google-btn');
    const facebookBtn = document.getElementById('sb-facebook-btn');
    const showCodeBtn = document.getElementById('sb-show-code');
    const codeSection = document.getElementById('sb-code-section');
    const codeInput = document.getElementById('sb-code-input');
    const verifyBtn = document.getElementById('sb-verify-btn');
    const resendBtn = document.getElementById('sb-resend');
    const errorMsg = document.getElementById('sb-error-msg');
    const successMsg = document.getElementById('sb-success-msg');

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹
    const requiredElements = {
      screen1, screen2, emailForm, emailInput, displayEmail,
      googleBtn, facebookBtn, showCodeBtn, codeSection, codeInput,
      verifyBtn, resendBtn, errorMsg, successMsg
    };

    for (const [name, element] of Object.entries(requiredElements)) {
      if (!element) {
        console.error(`âŒ Supabase Auth Form: Required element '${name}' not found!`);
        console.log('ğŸ’¡ Make sure the HTML structure is complete');
        return; // Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ±ĞµĞ· Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
      }
    }

    // ========== Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ SUPABASE ==========

    let supabaseClient;
    let authSubscription; // Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    let isInitialized = false; // Ğ¤Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

    function initSupabase() {
      // ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½ÑƒÑ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
      if (isInitialized) {
        console.log('âš ï¸ Supabase already initialized, skipping');
        return true;
      }

      if (!window.SUPABASE_CFG || !window.supabase) {
        return false;
      }

      try {
        const { createClient } = window.supabase;
        supabaseClient = createClient(
          window.SUPABASE_CFG.url,
          window.SUPABASE_CFG.anon
        );

        // ĞÑ‚Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ÑÑ Ğ¾Ñ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
        if (authSubscription) {
          authSubscription.data?.subscription?.unsubscribe();
        }

        // Ğ¡Ğ»ÑƒÑˆĞ°ĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
        authSubscription = supabaseClient.auth.onAuthStateChange(handleAuthChange);

        isInitialized = true; // ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ğº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹
        console.log('âœ… Supabase Auth initialized');
        return true;
      } catch (error) {
        console.error('Supabase init error:', error);
        showError('Failed to initialize Supabase');
        return false;
      }
    }

    // ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ retry
    function waitForSupabase(callback, maxAttempts = 20) {
      let attempts = 0;

      const checkAndInit = () => {
        attempts++;

        if (window.SUPABASE_CFG && window.supabase) {
          // ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°
          if (initSupabase()) {
            callback();
          } else {
            showError('Supabase initialization failed. Check console.');
          }
        } else if (attempts >= maxAttempts) {
          // ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº
          showError('Supabase not configured. Check wp-config.php or plugin activation.');
          console.error('âŒ SUPABASE_CFG not found after', maxAttempts, 'attempts');
          console.log('ğŸ’¡ Make sure supabase-bridge plugin is activated and wp-config.php is configured');
        } else {
          // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· Ñ‡ĞµÑ€ĞµĞ· 100ms
          setTimeout(checkAndInit, 100);
        }
      };

      checkAndInit();
    }

    // ========== Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« Ğ Ğ•Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞ’ ==========

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ» Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    const ORIGIN_PAGE = (function() {
      const params = new URLSearchParams(window.location.search);

      // 1. Explicit Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ redirect_to (Ğ²Ñ‹ÑÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
      if (params.get('redirect_to')) {
        console.log('ğŸ¯ ORIGIN_PAGE: from ?redirect_to =', params.get('redirect_to'));
        return params.get('redirect_to');
      }

      // 2. Referrer (Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ»)
      if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½
          if (referrerUrl.origin === window.location.origin) {
            console.log('ğŸ¯ ORIGIN_PAGE: from referrer =', referrerUrl.pathname);
            return referrerUrl.pathname;
          }
        } catch (e) {
          console.warn('Invalid referrer:', e);
        }
      }

      // 3. Fallback - Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
      console.log('ğŸ¯ ORIGIN_PAGE: fallback (current page) =', window.location.pathname);
      return window.location.pathname;
    })();

    // Security: Validate redirect URL to prevent open redirect attacks
    function isSafeRedirect(url) {
      if (!url) return false;

      // Allow relative paths (start with /)
      if (url.startsWith('/')) return true;

      // Check if URL is on same domain
      try {
        const urlObj = new URL(url, window.location.origin);
        return urlObj.origin === window.location.origin;
      } catch (e) {
        console.warn('Invalid redirect URL:', url);
        return false;
      }
    }

    function getReturnUrl() {
      // Ğ•ÑĞ»Ğ¸ origin page = Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° â†’ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ defaultRedirect (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ loop)
      if (ORIGIN_PAGE === window.location.pathname) {
        console.log('âš ï¸ ORIGIN_PAGE is current page, using defaultRedirect');
        return AUTH_CONFIG.defaultRedirect;
      }
      // Ğ”Ğ»Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸
      // Security: validate before returning
      if (!isSafeRedirect(ORIGIN_PAGE)) {
        console.warn('âš ï¸ Unsafe redirect detected, using defaultRedirect');
        return AUTH_CONFIG.defaultRedirect;
      }
      return ORIGIN_PAGE;
    }

    function getThankYouPage() {
      const params = new URLSearchParams(window.location.search);

      // 1. Explicit Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ thank_you (Ğ²Ñ‹ÑÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
      const customPage = params.get('thank_you');
      if (customPage) {
        // Security: validate custom page parameter
        if (!isSafeRedirect(customPage)) {
          console.warn('âš ï¸ Unsafe thank_you parameter detected, using default');
          return AUTH_CONFIG.thankYouPages.default;
        }
        return customPage;
      }

      // 2. Ğ˜Ñ‰ĞµĞ¼ Ğ² mapping Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ»
      if (AUTH_CONFIG.thankYouPages[ORIGIN_PAGE]) {
        return AUTH_CONFIG.thankYouPages[ORIGIN_PAGE];
      }

      // 3. Default fallback
      return AUTH_CONFIG.thankYouPages.default;
    }

    function isNewUser(user) {
      if (!user || !user.created_at) return false;

      const createdAt = new Date(user.created_at);
      const now = new Date();
      const diff = now - createdAt;

      return diff < AUTH_CONFIG.newUserThreshold;
    }

    // ========== ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ ==========

    let isRedirecting = false; // Ğ¤Ğ»Ğ°Ğ³ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ğ²
    const processingTokens = new Set(); // In-memory Set Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ¾Ñ‚ race condition

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ±Ñ‹Ğ» Ğ»Ğ¸ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½ Ğ² sessionStorage)
    let userTriggeredAuth = sessionStorage.getItem('sb_auth_triggered') === 'true';

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾ Magic Link (ĞµÑÑ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½ Ğ² URL hash)
    const hasMagicLinkToken = window.location.hash.includes('access_token=');

    async function handleAuthChange(event, session) {
      // ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ #0: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ isRedirecting ĞŸĞ•Ğ Ğ’Ğ«Ğœ Ğ”Ğ•Ğ›ĞĞœ (Ğ´Ğ¾ Ğ»ÑĞ±Ñ‹Ñ… Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº)
      // Ğ­Ñ‚Ğ¾ ÑĞ°Ğ¼Ğ°Ñ Ñ€Ğ°Ğ½Ğ½ÑÑ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ race condition
      if (isRedirecting) {
        console.log('âš ï¸ Already redirecting, skipping duplicate event');
        return;
      }

      console.log('Auth event:', event, 'userTriggered:', userTriggeredAuth, 'hasMagicLink:', hasMagicLinkToken);

      // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚
      // Ğ”Ğ°, ĞµÑĞ»Ğ¸: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ°Ğ» ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ˜Ğ›Ğ˜ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» Ğ¿Ğ¾ Magic Link
      const shouldRedirect = userTriggeredAuth || hasMagicLinkToken;

      // Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ğ¼ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞµÑĞ»Ğ¸:
      // 1. Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ = SIGNED_IN
      // 2. Ğ•ÑÑ‚ÑŒ ÑĞµÑÑĞ¸Ñ
      // 3. (ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ°Ğ» ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ˜Ğ›Ğ˜ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» Ğ¿Ğ¾ Magic Link)
      if (event === 'SIGNED_IN' && session && shouldRedirect) {
        const tokenKey = session.access_token.substring(0, 20);

        // ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ #1: In-memory Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ race condition Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹)
        if (processingTokens.has(tokenKey)) {
          console.log('âš ï¸ Token already processing (in-memory lock), skipping');
          return;
        }

        // ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ #2: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³Ğ¸ Ğ¡Ğ ĞĞ—Ğ£ Ğ˜ Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞĞ
        processingTokens.add(tokenKey);
        isRedirecting = true; // â† ĞŸĞµÑ€ĞµĞ½ĞµÑĞ»Ğ¸ Ğ¡Ğ®Ğ”Ğ - Ñ€Ğ°Ğ½ÑŒÑˆĞµ!

        // ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ #3: localStorage Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¼ĞµĞ¶Ğ´Ñƒ Ñ‚Ğ°Ğ±Ğ°Ğ¼Ğ¸/Ğ¾ĞºĞ½Ğ°Ğ¼Ğ¸)
        const processedTokenKey = 'sb_processed_' + tokenKey;
        if (localStorage.getItem(processedTokenKey)) {
          console.log('âš ï¸ Token already processed (localStorage), skipping');
          processingTokens.delete(tokenKey); // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ in-memory lock
          isRedirecting = false; // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³
          return;
        }

        // ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ Ğ² localStorage
        localStorage.setItem(processedTokenKey, 'processing');

        const user = session.user;
        const accessToken = session.access_token;

        try {
          // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ WordPress
          const wpResponse = await fetch(window.location.origin + '/wp-json/supabase-auth/callback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token: accessToken })
          });

          const wpData = await wpResponse.json();

          if (!wpResponse.ok) {
            throw new Error(wpData.message || 'WordPress authentication failed');
          }

          // âœ… ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ ĞºĞ°Ğº Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° WordPress
          localStorage.setItem(processedTokenKey, 'true');
          // ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
          setTimeout(() => localStorage.removeItem(processedTokenKey), 300000);

          // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºÑƒĞ´Ğ° Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ñ‚ÑŒ
          const redirectUrl = isNewUser(user)
            ? getThankYouPage()
            : getReturnUrl();

          console.log('Redirecting to:', redirectUrl, '(new user:', isNewUser(user), ')');

          // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿ĞµÑ€ĞµĞ´ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ğ¼
          sessionStorage.removeItem('sb_auth_triggered');

          // Ğ ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚
          window.location.href = redirectUrl;

        } catch (error) {
          console.error('Auth error:', error);
          showError(error.message || 'Authentication failed');

          // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ (Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°)
          processingTokens.delete(tokenKey); // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ in-memory lock
          localStorage.removeItem(processedTokenKey); // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ localStorage
          isRedirecting = false;
        }
      }
    }

    // ========== EMAIL MAGIC LINK ==========

    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();

      if (!email) return;

      if (!supabaseClient) {
        showError('Supabase not initialized yet. Please wait...');
        return;
      }

      // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» email
      userTriggeredAuth = true;
      sessionStorage.setItem('sb_auth_triggered', 'true');
      console.log('ğŸ¯ User submitted email for magic link');

      try {
        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° magic link
        const { error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });

        if (error) throw error;

        // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½ 2
        displayEmail.textContent = email;
        switchScreen(2);
        showSuccess('Magic link sent! Check your email.');

      } catch (error) {
        console.error('Magic link error:', error);
        showError(error.message || 'Failed to send magic link');
      }
    });

    // ========== GOOGLE OAUTH ==========

    googleBtn.addEventListener('click', async () => {
      if (!supabaseClient) {
        showError('Supabase not initialized yet. Please wait...');
        return;
      }

      // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ°Ğ¼ Ğ½Ğ°Ğ¶Ğ°Ğ» ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
      userTriggeredAuth = true;
      sessionStorage.setItem('sb_auth_triggered', 'true');
      console.log('ğŸ¯ User clicked Google OAuth button');

      try {
        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin + window.location.pathname
          }
        });

        if (error) throw error;

      } catch (error) {
        console.error('OAuth error:', error);
        showError(error.message || 'OAuth authentication failed');
      }
    });

    // ========== FACEBOOK OAUTH ==========

    facebookBtn.addEventListener('click', async () => {
      if (!supabaseClient) {
        showError('Supabase not initialized yet. Please wait...');
        return;
      }

      // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ°Ğ¼ Ğ½Ğ°Ğ¶Ğ°Ğ» ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
      userTriggeredAuth = true;
      sessionStorage.setItem('sb_auth_triggered', 'true');
      console.log('ğŸ¯ User clicked Facebook OAuth button');

      try {
        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'facebook',
          options: {
            redirectTo: window.location.origin + window.location.pathname,
            scopes: 'email public_profile'
          }
        });

        if (error) throw error;

      } catch (error) {
        console.error('OAuth error:', error);
        showError(error.message || 'OAuth authentication failed');
      }
    });

    // ========== VERIFICATION CODE ==========

    showCodeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      codeSection.classList.add('active');
      showCodeBtn.style.display = 'none';
      codeInput.focus();
    });

    verifyBtn.addEventListener('click', async () => {
      const email = displayEmail.textContent;
      const code = codeInput.value.trim();

      if (code.length !== 6) {
        showError('Please enter a 6-digit code');
        return;
      }

      if (!supabaseClient) {
        showError('Supabase not initialized yet. Please wait...');
        return;
      }

      try {
        const { error } = await supabaseClient.auth.verifyOtp({
          email: email,
          token: code,
          type: 'email'
        });

        if (error) throw error;

        // handleAuthChange ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸

      } catch (error) {
        console.error('Verification error:', error);
        showError(error.message || 'Invalid verification code');
      }
    });

    // ========== RESEND ==========

    resendBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = displayEmail.textContent;

      if (!supabaseClient) {
        showError('Supabase not initialized yet. Please wait...');
        return;
      }

      try {
        const { error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });

        if (error) throw error;

        showSuccess('Email sent again!');

      } catch (error) {
        console.error('Resend error:', error);
        showError(error.message || 'Failed to resend email');
      }
    });

    // ========== Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« UI ==========

    function switchScreen(num) {
      screen1.classList.remove('active');
      screen2.classList.remove('active');

      if (num === 1) screen1.classList.add('active');
      if (num === 2) screen2.classList.add('active');
    }

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.add('active');
      setTimeout(() => errorMsg.classList.remove('active'), 5000);
    }

    function showSuccess(message) {
      successMsg.textContent = message;
      successMsg.classList.add('active');
      setTimeout(() => successMsg.classList.remove('active'), 3000);
    }

    // ========== Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ==========

    // Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ SUPABASE_CFG Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼
    waitForSupabase(() => {
      console.log('ğŸ¯ Ready to authenticate');
    });

    // ========== GLOBAL API ==========

    window.sbAuth = {
      switchScreen,
      showError,
      showSuccess,
      reset: () => {
        emailInput.value = '';
        codeInput.value = '';
        codeSection.classList.remove('active');
        showCodeBtn.style.display = '';
        switchScreen(1);
      },
      config: AUTH_CONFIG,
      client: supabaseClient
    };

      } catch (error) {
        console.error('âŒ Supabase Auth Form initialization error:', error);
        console.log('ğŸ’¡ Check browser console for details');
        // ĞĞµ Ğ¿Ñ€Ğ¾Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ´Ğ°Ğ»ÑŒÑˆĞµ - Ğ¿ÑƒÑÑ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
      }
    } // end of initAuthForm()
  })(); // end of IIFE
</script>

<!--
  Ğ“ĞĞ¢ĞĞ’Ğ:
  âœ… Supabase SDK Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ
  âœ… Magic Link (signInWithOtp)
  âœ… Verification Code
  âœ… Google OAuth
  âœ… Ğ£Ğ¼Ğ½Ñ‹Ğµ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ñ‹ (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ vs ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹)
  âœ… ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ thank you pages
  âœ… WordPress ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

  ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ:
  Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸ AUTH_CONFIG.thankYouPages Ğ´Ğ»Ñ ÑĞ²Ğ¾Ğ¸Ñ… ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†!
-->