<!--
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Supabase Authentication Callback Handler
  For /test-no-elem-2/ page

  Instructions:
  1. Edit /test-no-elem-2/ page in WordPress
  2. Switch to HTML/Code editor
  3. Paste this entire code
  4. Save and publish
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<!-- INSTANT LOADING SCREEN (Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¡Ğ ĞĞ—Ğ£, ÑƒĞ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ±ĞµĞ»Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½) -->
<style>
  #instant-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  #instant-loader.hidden {
    display: none;
  }

  .instant-dots {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
  }

  .instant-dot {
    width: 12px;
    height: 12px;
    background: #667eea;
    border-radius: 50%;
    animation: instant-bounce 1.4s infinite ease-in-out both;
  }

  .instant-dot:nth-child(1) {
    animation-delay: -0.32s;
  }

  .instant-dot:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes instant-bounce {
    0%, 80%, 100% {
      transform: scale(0);
    }
    40% {
      transform: scale(1);
    }
  }
</style>

<div id="instant-loader">
  <div style="text-align: center;">
    <h2 style="color: #16a34a; font-size: 24px; margin: 0; font-weight: 600;">âœ“ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!</h2>
    <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p>
    <div class="instant-dots">
      <div class="instant-dot"></div>
      <div class="instant-dot"></div>
      <div class="instant-dot"></div>
    </div>
  </div>
</div>

<!-- ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ¢Ğ•ĞĞ¢ (ÑĞºÑ€Ñ‹Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ instant loader) -->
<style>
  .auth-callback-container {
    display: none; /* Ğ¡ĞºÑ€Ñ‹Ñ‚ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ instant loader */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 480px;
    margin: 60px auto;
    padding: 48px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    text-align: center;
  }

  .auth-spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto 24px;
    border: 4px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: auth-spin 1s linear infinite;
  }

  @keyframes auth-spin {
    to { transform: rotate(360deg); }
  }

  .auth-status {
    font-size: 18px;
    color: #374151;
    margin: 24px 0;
    line-height: 1.6;
  }

  .auth-status.success {
    color: #16a34a;
    font-weight: 600;
  }

  .auth-status.error {
    color: #dc2626;
    font-weight: 600;
    background: #fef2f2;
    padding: 16px;
    border-radius: 8px;
  }

  .auth-debug {
    background: #f3f4f6;
    padding: 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 13px;
    text-align: left;
    font-family: 'Courier New', monospace;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }

  .auth-retry {
    margin-top: 24px;
  }

  .auth-retry a {
    color: #3b82f6;
    text-decoration: underline;
    font-weight: 500;
  }
</style>

<div class="auth-callback-container">
  <div class="auth-spinner" id="authSpinner"></div>
  <div class="auth-status" id="authStatus">âœ“ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ! ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ¶ĞºĞ¾... (5)</div>
  <div class="auth-debug" id="authDebug"></div>
  <div class="auth-retry" id="authRetry" style="display: none;">
    <a href="/">Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ½Ğ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ</a>
  </div>
</div>

<script>
(function() {
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Safe localStorage wrapper (Safari Privacy Protection)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const safeStorage = (function() {
    let memoryStorage = {}; // Fallback Ğ´Ğ»Ñ Safari Privacy mode
    let storageAvailable = false;

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ localStorage
    try {
      const testKey = '__storage_test__';
      localStorage.setItem(testKey, 'test');
      localStorage.removeItem(testKey);
      storageAvailable = true;
    } catch (e) {
      console.warn('âš ï¸  localStorage Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Safari Privacy Protection, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ in-memory fallback');
      storageAvailable = false;
    }

    return {
      getItem: function(key) {
        try {
          return storageAvailable ? localStorage.getItem(key) : memoryStorage[key] || null;
        } catch (e) {
          return memoryStorage[key] || null;
        }
      },
      setItem: function(key, value) {
        try {
          if (storageAvailable) {
            localStorage.setItem(key, value);
          } else {
            memoryStorage[key] = value;
          }
        } catch (e) {
          memoryStorage[key] = value;
        }
      },
      removeItem: function(key) {
        try {
          if (storageAvailable) {
            localStorage.removeItem(key);
          } else {
            delete memoryStorage[key];
          }
        } catch (e) {
          delete memoryStorage[key];
        }
      }
    };
  })();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Configuration
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const CONFIG = {
    DEBUG_MODE: false,          // Set to true to see debug info
    THANK_YOU_PAGE: '/registr/', // Default thank you page for new users
    DEFAULT_REDIRECT: '/',       // Fallback for existing users
    NEW_USER_THRESHOLD: 60000    // 60 seconds to consider "new user"
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DOM Elements
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const spinner = document.getElementById('authSpinner');
  const status = document.getElementById('authStatus');
  const debugPanel = document.getElementById('authDebug');
  const retryPanel = document.getElementById('authRetry');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Telemetry (v0.10.2)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function trackTelemetry(event, data) {
    try {
      console.log('ğŸ“Š trackTelemetry called:', event, data);

      if (!window.SUPABASE_CFG) {
        console.warn('âš ï¸ SUPABASE_CFG not found - telemetry disabled');
        return Promise.resolve(); // Supabase not configured
      }

      const urlParams = new URLSearchParams(window.location.search);
      const payload = JSON.stringify({
        event: event,
        created_at: new Date().toISOString(),
        user_agent: navigator.userAgent.substring(0, 200),
        referrer: document.referrer || null,
        registration_url: urlParams.get('registration_url') || null,
        landing_url: urlParams.get('landing_url') || safeStorage.getItem('sb_landing_url') || null,
        ...data
      });

      const url = window.SUPABASE_CFG.url + '/rest/v1/auth_telemetry';
      console.log('ğŸ“¤ Sending telemetry to:', url);

      // Use fetch with keepalive (non-blocking, works even on page close)
      // Note: sendBeacon doesn't support custom headers, so we use fetch instead
      return fetch(url, {
        method: 'POST',
        headers: {
          'apikey': window.SUPABASE_CFG.anon,
          'Authorization': 'Bearer ' + window.SUPABASE_CFG.anon,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: payload,
        keepalive: true
      }).then(res => {
        console.log('âœ… Telemetry sent successfully:', event, res.status);
        return res;
      }).catch(err => {
        console.error('âŒ Telemetry fetch failed:', event, err);
      }); // Silent fail - telemetry never breaks auth
    } catch (e) {
      console.error('âŒ Telemetry error:', e);
      // Silent fail - telemetry never breaks auth
      return Promise.resolve();
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Utility Functions
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function debug(message, data = null) {
    console.log('[Auth Callback]', message, data || '');

    if (CONFIG.DEBUG_MODE) {
      debugPanel.style.display = 'block';
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      if (data) {
        line.textContent += ': ' + (typeof data === 'object' ? JSON.stringify(data) : data);
      }
      debugPanel.appendChild(line);
    }
  }

  function updateStatus(message, type = 'normal') {
    status.textContent = message;
    status.className = 'auth-status';

    if (type === 'success') {
      status.classList.add('success');
      spinner.style.display = 'none';
    } else if (type === 'error') {
      status.classList.add('error');
      spinner.style.display = 'none';
      retryPanel.style.display = 'block';
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Token Extraction
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function extractTokensFromHash() {
    debug('Extracting tokens from URL');
    debug('Current URL', window.location.href);
    debug('Hash fragment', window.location.hash);
    debug('Query string', window.location.search);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 1: Check for Supabase errors FIRST (before looking for tokens)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const hash = window.location.hash;
    if (hash && hash.includes('error=')) {
      debug('Supabase error detected in URL hash');
      const errorParams = new URLSearchParams(hash.substring(1));
      const errorCode = errorParams.get('error_code');
      const errorType = errorParams.get('error');
      const errorDescription = errorParams.get('error_description');

      debug('Error code', errorCode);
      debug('Error type', errorType);
      debug('Error description', errorDescription);

      // User-friendly messages for common errors
      let userMessage;

      if (errorCode === 'otp_expired') {
        userMessage = 'Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° ÑƒÑÑ‚Ğ°Ñ€ĞµĞ»Ğ° (Ğ¸ÑÑ‚Ñ‘Ğº ÑÑ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ). Ğ’ĞĞ–ĞĞ: Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ğ»Ğ¸ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¡ĞĞœĞĞ• ĞĞĞ’ĞĞ• Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾. Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ñ….';
      } else if (errorCode === 'otp_disabled') {
        userMessage = 'Ğ’Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ email Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Google Ğ¸Ğ»Ğ¸ Facebook.';
      } else if (errorType === 'access_denied') {
        userMessage = 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½. Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ÑÑ, ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹.';
      } else {
        // Generic error with description from Supabase
        userMessage = errorDescription
          ? decodeURIComponent(errorDescription.replace(/\+/g, ' '))
          : 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°. Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ÑÑ, ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹.';
      }

      // Track telemetry: auth failure (v0.10.2)
      trackTelemetry('auth_failure', {
        error_code: errorCode || errorType,
        error_message: errorDescription || userMessage,
        provider: 'unknown' // Provider unknown at error stage
      });

      throw new Error(userMessage);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 2: No errors â†’ Extract authentication tokens
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let params;
    let source;

    // Try hash fragment first (Implicit flow)
    if (hash && hash.includes('access_token=')) {
      params = new URLSearchParams(hash.substring(1));
      source = 'hash fragment (Implicit flow)';
    }
    // Fallback to query string (PKCE flow)
    else if (window.location.search && window.location.search.includes('access_token=')) {
      params = new URLSearchParams(window.location.search.substring(1));
      source = 'query string (PKCE flow)';
    }
    else {
      throw new Error('Ğ¢Ğ¾ĞºĞµĞ½ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² URL. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²Ğ¾Ğ»ÑˆĞµĞ±Ğ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ.');
    }

    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const tokenType = params.get('token_type');

    if (!accessToken) {
      throw new Error('Ğ¢Ğ¾ĞºĞµĞ½ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² URL');
    }

    debug('Tokens extracted successfully from ' + source);
    debug('Access token preview', accessToken.substring(0, 20) + '...');

    // Track telemetry: MagicLink clicked / OAuth callback (v0.10.2)
    trackTelemetry('magic_link_clicked', {
      has_hash: window.location.hash.includes('access_token'),
      source: source
    });

    return {
      access_token: accessToken,
      refresh_token: refreshToken,
      token_type: tokenType
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WordPress Authentication
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function authenticateWithWordPress(tokens) {
    debug('Calling WordPress REST API');

    const endpoint = window.location.origin + '/wp-json/supabase-bridge/v1/callback';
    debug('Endpoint', endpoint);

    // Determine registration_url with priority:
    // 1. URL query param (Magic Link - works across devices)
    // 2. localStorage (OAuth or same tab - works on same device)
    // 3. Current page path (fallback)
    const urlParams = new URLSearchParams(window.location.search);
    const registration_url = urlParams.get('registration_url') ||
                            safeStorage.getItem('registration_page_url') ||
                            window.location.pathname;

    debug('Registration URL determined', registration_url);

    // Determine landing_url for marketing analytics (v0.10.0)
    // 1. URL query param (Magic Link - works across devices)
    // 2. localStorage (OAuth - works on same device)
    // 3. null (user came directly to auth form)
    const landing_url = urlParams.get('landing_url') ||
                       safeStorage.getItem('sb_landing_url') ||
                       null;

    debug('Landing URL determined', landing_url);

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          access_token: tokens.access_token,
          registration_url: registration_url,
          landing_url: landing_url
        }),
        credentials: 'include' // CRITICAL: Include cookies
      });

      debug('Response status', response.status);

      const data = await response.json();
      debug('Response data', data);

      // Handle duplicate callback (another tab/window already processing)
      if (response.status === 409) {
        debug('Duplicate callback detected');
        updateStatus('ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ² Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼ Ğ¾ĞºĞ½Ğµ...');
        setTimeout(() => {
          window.location.href = CONFIG.DEFAULT_REDIRECT;
        }, 2000);
        return null;
      }

      // Handle error responses
      if (!response.ok) {
        throw new Error(data.message || `ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ (HTTP ${response.status})`);
      }

      return data;

    } catch (error) {
      debug('WordPress API error', error.message);
      throw error;
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Redirect Logic
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function getRedirectUrl(wpResponse) {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRIORITY-BASED REDIRECT LOGIC (v0.9.11)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //
    // Priority 1: Backend set redirect_url (Registration Pairs)
    //   â†’ User came from landing page form (e.g., /reg_ai_intro/)
    //   â†’ Redirect to Thank You page (regardless of NEW vs EXISTING)
    //
    // Priority 2: Return URL (General Login)
    //   â†’ User came from general login in menu (e.g., /test-no-elem/)
    //   â†’ Return to page where they came from
    //
    // Priority 3: Default fallback
    //   â†’ Home page or global default
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // PRIORITY 1: Check if backend set redirect_url (Registration Pairs)
    if (wpResponse && wpResponse.redirect_url) {
      // Backend found this form in Registration Pairs â†’ Landing page scenario
      debug('âœ“ Backend set redirect_url (Landing Page Form)', wpResponse.redirect_url);
      debug('  â†’ Redirecting to Thank You page (user came from targeted landing)');
      return wpResponse.redirect_url;
    }

    // PRIORITY 2: No redirect_url â†’ General login scenario â†’ Use Return URL
    // Read redirect_to parameter from URL query string
    const urlParams = new URLSearchParams(window.location.search);
    let redirectTo = urlParams.get('redirect_to');

    // Fallback: Read from localStorage (saved on login page)
    if (!redirectTo) {
      redirectTo = safeStorage.getItem('login_return_url');
    }

    if (redirectTo) {
      debug('âœ“ Using Return URL (General Login)', redirectTo);
      debug('  â†’ User came from menu login, returning to origin page');
      return redirectTo;
    }

    // PRIORITY 3: Default fallback
    debug('âœ“ Using default redirect', CONFIG.DEFAULT_REDIRECT);
    debug('  â†’ No specific redirect found, using global default');
    return CONFIG.DEFAULT_REDIRECT;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Main Authentication Flow
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function processAuthentication() {
    debug('Starting authentication process');

    // Diagnostic tracking for timeout monitoring
    const diagnostics = {
      urlParsed: false,
      wpCalled: false,
      wpSuccess: false,
      redirected: false,
      error: null,
      startTime: Date.now()
    };

    // Silent timeout monitoring (20 seconds)
    setTimeout(() => {
      if (!diagnostics.redirected) {
        // Callback is stuck - send telemetry
        console.error('âš ï¸ Callback timeout: redirect did not happen in 20 seconds', diagnostics);

        trackTelemetry('callback_timeout', {
          timeout_seconds: 20,
          url_parsed: diagnostics.urlParsed,
          wordpress_called: diagnostics.wpCalled,
          wordpress_success: diagnostics.wpSuccess,
          error_message: diagnostics.error || null,
          elapsed_ms: Date.now() - diagnostics.startTime,
          callback_url: window.location.href,
          referrer: document.referrer || null
        });

        // Show support contact message
        clearInterval(dotsTimer);
        const instantLoader = document.getElementById('instant-loader');
        if (instantLoader) {
          instantLoader.innerHTML = `
            <div style="text-align: center; max-width: 400px; padding: 40px;">
              <h2 style="color: #dc2626; font-size: 24px; margin: 0 0 20px 0; font-weight: 600;">âš ï¸ Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº</h2>
              <p style="color: #666; font-size: 16px; margin: 0 0 30px 0; line-height: 1.5;">
                Ğ’Ñ…Ğ¾Ğ´ Ğ·Ğ°Ğ½ÑĞ» ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ.
              </p>
              <a href="mailto:support@alexeykrol.com" style="
                display: inline-block;
                padding: 14px 28px;
                background: #2563eb;
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 16px;
                transition: background 0.2s;
              " onmouseover="this.style.background='#1d4ed8'"
                 onmouseout="this.style.background='#2563eb'">
                ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ
              </a>
            </div>
          `;
        }
      }
    }, 20000); // 20 seconds

    // Update instant loader content instead of hiding it (avoid flickering)
    const instantLoader = document.getElementById('instant-loader');
    const instantLoaderContent = instantLoader ? instantLoader.querySelector('div') : null;

    if (instantLoaderContent) {
      // Replace loading dots with simple message
      instantLoaderContent.innerHTML = `
        <h2 style="color: #16a34a; font-size: 24px; margin: 0; font-weight: 600;">âœ“ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!</h2>
        <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;" id="instant-status">ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ¶ĞºĞ¾.</p>
      `;
    }

    // Animated dots (shows progress without specific timing)
    let dotCount = 1;
    const dotsTimer = setInterval(() => {
      dotCount = (dotCount % 5) + 1; // 1-5 dots cycle
      const dots = '.'.repeat(dotCount);
      const instantStatus = document.getElementById('instant-status');
      if (instantStatus) {
        instantStatus.textContent = `ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ¶ĞºĞ¾${dots}`;
      }
    }, 400);

    try {
      // Step 1: Extract tokens from URL hash
      const tokens = extractTokensFromHash();
      diagnostics.urlParsed = true;

      // Step 2: Authenticate with WordPress
      diagnostics.wpCalled = true;
      const wpResponse = await authenticateWithWordPress(tokens);
      diagnostics.wpSuccess = true;

      // Handle duplicate callback (null response)
      if (wpResponse === null) {
        clearInterval(dotsTimer);
        return;
      }

      // Step 3: Determine redirect URL
      const redirectUrl = getRedirectUrl(wpResponse);

      // DEBUG: Log before telemetry
      console.log('ğŸ¯ About to send auth_success telemetry:', {
        email: wpResponse.user_email,
        supabase_user_id: wpResponse.supabase_user_id,
        is_new_user: wpResponse.is_new_user,
        provider: wpResponse.provider
      });

      // Track telemetry: auth success (v0.10.2)
      // Wait for telemetry to send before redirect (with timeout)
      const telemetryPromise = trackTelemetry('auth_success', {
        email: wpResponse.user_email || null,
        supabase_user_id: wpResponse.supabase_user_id || null,
        is_new_user: wpResponse.is_new_user || false,
        provider: wpResponse.provider || 'unknown'
      });

      // Wait max 1 second for telemetry, then redirect anyway
      Promise.race([
        telemetryPromise,
        new Promise(resolve => setTimeout(resolve, 1000))
      ]).then(() => {
        // Step 4: Success! Redirect user
        debug('Redirecting to', redirectUrl);

        // Clean localStorage (no longer needed after login)
        safeStorage.removeItem('login_return_url');
        safeStorage.removeItem('registration_page_url');
        debug('Cleaned localStorage (login_return_url, registration_page_url)');

        // Clean URL hash and redirect
        clearInterval(dotsTimer);
        diagnostics.redirected = true;
        window.location.href = redirectUrl;
      });

    } catch (error) {
      console.error('[Auth Callback] Error:', error);
      debug('Authentication failed', error.toString());
      diagnostics.error = error.message || error.toString();
      clearInterval(dotsTimer);

      // Get registration_url to provide helpful retry link
      const urlParams = new URLSearchParams(window.location.search);
      const formPageUrl = urlParams.get('registration_url') || '/';

      // Update error message
      updateStatus('âš ï¸ ' + error.message, 'error');

      // Update retry panel with link to form page
      const retryPanel = document.getElementById('authRetry');
      if (retryPanel) {
        retryPanel.innerHTML = `
          <p style="color: #666; font-size: 14px; margin: 15px 0;">
            Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ ÑĞ½Ğ¾Ğ²Ğ°, Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğº Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°:
          </p>
          <a href="${formPageUrl}" style="
            display: inline-block;
            padding: 12px 24px;
            background: #2563eb;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: background 0.2s;
          " onmouseover="this.style.background='#1d4ed8'"
             onmouseout="this.style.background='#2563eb'">
            ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°
          </a>
        `;
        retryPanel.style.display = 'block';
      }
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Initialize
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  debug('Auth callback handler loaded');

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', processAuthentication);
  } else {
    processAuthentication();
  }

})();
</script>

<!--
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Installation Complete!

  This page will now:
  1. Extract Supabase tokens from URL hash
  2. Authenticate with WordPress REST API
  3. Create WordPress session
  4. Redirect based on user type:
     - EXISTING USER (login): Return to ?redirect_to= page or default
     - NEW USER (registration): Thank You page from Registration Pairs

  URL Parameters:
  - ?redirect_to=/premium-course/ â†’ Returns existing user to that page

  Debug Mode:
  - Set CONFIG.DEBUG_MODE = true to see detailed logs
  - Check browser console for detailed information
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
