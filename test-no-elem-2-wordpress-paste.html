<!--
  ═══════════════════════════════════════════════════════════════
  Supabase Authentication Callback Handler
  For /test-no-elem-2/ page

  Instructions:
  1. Edit /test-no-elem-2/ page in WordPress
  2. Switch to HTML/Code editor
  3. Paste this entire code
  4. Save and publish
  ═══════════════════════════════════════════════════════════════
-->

<style>
  .auth-callback-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 480px;
    margin: 60px auto;
    padding: 48px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    text-align: center;
  }

  .auth-spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto 24px;
    border: 4px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: auth-spin 1s linear infinite;
  }

  @keyframes auth-spin {
    to { transform: rotate(360deg); }
  }

  .auth-status {
    font-size: 18px;
    color: #374151;
    margin: 24px 0;
    line-height: 1.6;
  }

  .auth-status.success {
    color: #16a34a;
    font-weight: 600;
  }

  .auth-status.error {
    color: #dc2626;
    font-weight: 600;
    background: #fef2f2;
    padding: 16px;
    border-radius: 8px;
  }

  .auth-debug {
    background: #f3f4f6;
    padding: 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 13px;
    text-align: left;
    font-family: 'Courier New', monospace;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }

  .auth-retry {
    margin-top: 24px;
  }

  .auth-retry a {
    color: #3b82f6;
    text-decoration: underline;
    font-weight: 500;
  }
</style>

<div class="auth-callback-container">
  <div class="auth-spinner" id="authSpinner"></div>
  <div class="auth-status" id="authStatus">Processing authentication...</div>
  <div class="auth-debug" id="authDebug"></div>
  <div class="auth-retry" id="authRetry" style="display: none;">
    <a href="/">Return to home page</a>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════════════════
  // Configuration
  // ═══════════════════════════════════════════════════════════

  const CONFIG = {
    DEBUG_MODE: false,          // Set to true to see debug info
    THANK_YOU_PAGE: '/registr/', // Default thank you page for new users
    DEFAULT_REDIRECT: '/',       // Fallback for existing users
    NEW_USER_THRESHOLD: 60000    // 60 seconds to consider "new user"
  };

  // ═══════════════════════════════════════════════════════════
  // DOM Elements
  // ═══════════════════════════════════════════════════════════

  const spinner = document.getElementById('authSpinner');
  const status = document.getElementById('authStatus');
  const debugPanel = document.getElementById('authDebug');
  const retryPanel = document.getElementById('authRetry');

  // ═══════════════════════════════════════════════════════════
  // Utility Functions
  // ═══════════════════════════════════════════════════════════

  function debug(message, data = null) {
    console.log('[Auth Callback]', message, data || '');

    if (CONFIG.DEBUG_MODE) {
      debugPanel.style.display = 'block';
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      if (data) {
        line.textContent += ': ' + (typeof data === 'object' ? JSON.stringify(data) : data);
      }
      debugPanel.appendChild(line);
    }
  }

  function updateStatus(message, type = 'normal') {
    status.textContent = message;
    status.className = 'auth-status';

    if (type === 'success') {
      status.classList.add('success');
      spinner.style.display = 'none';
    } else if (type === 'error') {
      status.classList.add('error');
      spinner.style.display = 'none';
      retryPanel.style.display = 'block';
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Token Extraction
  // ═══════════════════════════════════════════════════════════

  function extractTokensFromHash() {
    debug('Extracting tokens from URL hash');
    debug('Current URL', window.location.href);
    debug('Hash fragment', window.location.hash);

    const hash = window.location.hash;

    // Check if we have a hash with access_token
    if (!hash || !hash.includes('access_token=')) {
      throw new Error('No authentication token found in URL. Please click the magic link in your email.');
    }

    // Parse hash (remove # and parse as URLSearchParams)
    const params = new URLSearchParams(hash.substring(1));
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const tokenType = params.get('token_type');

    if (!accessToken) {
      throw new Error('Access token is missing from URL');
    }

    debug('Tokens extracted successfully');
    debug('Access token preview', accessToken.substring(0, 20) + '...');

    return {
      access_token: accessToken,
      refresh_token: refreshToken,
      token_type: tokenType
    };
  }

  // ═══════════════════════════════════════════════════════════
  // WordPress Authentication
  // ═══════════════════════════════════════════════════════════

  async function authenticateWithWordPress(tokens) {
    updateStatus('Signing in to your account...');
    debug('Calling WordPress REST API');

    const endpoint = window.location.origin + '/wp-json/supabase-bridge/v1/callback';
    debug('Endpoint', endpoint);

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          access_token: tokens.access_token,
          registration_url: '/test-no-elem-2/' // Track registration source
        }),
        credentials: 'include' // CRITICAL: Include cookies
      });

      debug('Response status', response.status);

      const data = await response.json();
      debug('Response data', data);

      // Handle duplicate callback (another tab/window already processing)
      if (response.status === 409) {
        debug('Duplicate callback detected');
        updateStatus('Authentication in progress in another window...');
        setTimeout(() => {
          window.location.href = CONFIG.DEFAULT_REDIRECT;
        }, 2000);
        return null;
      }

      // Handle error responses
      if (!response.ok) {
        throw new Error(data.message || `Authentication failed (HTTP ${response.status})`);
      }

      return data;

    } catch (error) {
      debug('WordPress API error', error.message);
      throw error;
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Redirect Logic
  // ═══════════════════════════════════════════════════════════

  function getRedirectUrl(wpResponse) {
    // Read redirect_to parameter from URL query string
    const urlParams = new URLSearchParams(window.location.search);
    const redirectTo = urlParams.get('redirect_to');

    debug('URL parameters', window.location.search);
    debug('redirect_to parameter', redirectTo || 'not set');

    // WordPress tells us if user is new
    const isNewUser = wpResponse && wpResponse.is_new_user;
    debug('User type', isNewUser ? 'NEW (registration)' : 'EXISTING (login)');

    if (isNewUser) {
      // CASE 2: REGISTRATION (new user)
      // Use Thank You page from WordPress API (Registration Pairs) or default
      const thankYouUrl = wpResponse.redirect_url || CONFIG.THANK_YOU_PAGE;
      debug('REGISTRATION → Thank you page', thankYouUrl);
      return thankYouUrl;
    } else {
      // CASE 1: LOGIN (existing user)
      // Return to origin page (from redirect_to parameter) or default
      const returnUrl = redirectTo || CONFIG.DEFAULT_REDIRECT;
      debug('LOGIN → Return to origin page', returnUrl);
      return returnUrl;
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Main Authentication Flow
  // ═══════════════════════════════════════════════════════════

  async function processAuthentication() {
    debug('Starting authentication process');

    try {
      // Step 1: Extract tokens from URL hash
      updateStatus('Reading authentication token...');
      const tokens = extractTokensFromHash();

      // Step 2: Authenticate with WordPress
      updateStatus('Authenticating...');
      const wpResponse = await authenticateWithWordPress(tokens);

      // Handle duplicate callback (null response)
      if (wpResponse === null) {
        return;
      }

      // Step 3: Determine redirect URL
      const redirectUrl = getRedirectUrl(wpResponse);

      // Step 4: Success! Redirect user
      updateStatus('✓ Welcome! Redirecting...', 'success');
      debug('Redirecting to', redirectUrl);

      // Clean URL hash and redirect
      setTimeout(() => {
        window.location.href = redirectUrl;
      }, 1000);

    } catch (error) {
      console.error('[Auth Callback] Error:', error);
      debug('Authentication failed', error.toString());
      updateStatus('⚠ Authentication failed: ' + error.message, 'error');
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Initialize
  // ═══════════════════════════════════════════════════════════

  debug('Auth callback handler loaded');

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', processAuthentication);
  } else {
    processAuthentication();
  }

})();
</script>

<!--
  ═══════════════════════════════════════════════════════════════
  Installation Complete!

  This page will now:
  1. Extract Supabase tokens from URL hash
  2. Authenticate with WordPress REST API
  3. Create WordPress session
  4. Redirect based on user type:
     - EXISTING USER (login): Return to ?redirect_to= page or default
     - NEW USER (registration): Thank You page from Registration Pairs

  URL Parameters:
  - ?redirect_to=/premium-course/ → Returns existing user to that page

  Debug Mode:
  - Set CONFIG.DEBUG_MODE = true to see detailed logs
  - Check browser console for detailed information
  ═══════════════════════════════════════════════════════════════
-->
