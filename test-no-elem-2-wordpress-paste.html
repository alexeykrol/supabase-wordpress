<!--
  ═══════════════════════════════════════════════════════════════
  Supabase Authentication Callback Handler
  For /test-no-elem-2/ page

  Instructions:
  1. Edit /test-no-elem-2/ page in WordPress
  2. Switch to HTML/Code editor
  3. Paste this entire code
  4. Save and publish
  ═══════════════════════════════════════════════════════════════
-->

<!-- INSTANT LOADING SCREEN (показывается СРАЗУ, убирает белый экран) -->
<style>
  #instant-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  #instant-loader.hidden {
    display: none;
  }

  .instant-dots {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
  }

  .instant-dot {
    width: 12px;
    height: 12px;
    background: #667eea;
    border-radius: 50%;
    animation: instant-bounce 1.4s infinite ease-in-out both;
  }

  .instant-dot:nth-child(1) {
    animation-delay: -0.32s;
  }

  .instant-dot:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes instant-bounce {
    0%, 80%, 100% {
      transform: scale(0);
    }
    40% {
      transform: scale(1);
    }
  }
</style>

<div id="instant-loader">
  <div style="text-align: center;">
    <h2 style="color: #16a34a; font-size: 24px; margin: 0; font-weight: 600;">✓ Добро пожаловать!</h2>
    <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;">Загрузка...</p>
    <div class="instant-dots">
      <div class="instant-dot"></div>
      <div class="instant-dot"></div>
      <div class="instant-dot"></div>
    </div>
  </div>
</div>

<!-- ОСНОВНОЙ КОНТЕНТ (скрыт, используем только instant loader) -->
<style>
  .auth-callback-container {
    display: none; /* Скрыт - используем только instant loader */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 480px;
    margin: 60px auto;
    padding: 48px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    text-align: center;
  }

  .auth-spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto 24px;
    border: 4px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: auth-spin 1s linear infinite;
  }

  @keyframes auth-spin {
    to { transform: rotate(360deg); }
  }

  .auth-status {
    font-size: 18px;
    color: #374151;
    margin: 24px 0;
    line-height: 1.6;
  }

  .auth-status.success {
    color: #16a34a;
    font-weight: 600;
  }

  .auth-status.error {
    color: #dc2626;
    font-weight: 600;
    background: #fef2f2;
    padding: 16px;
    border-radius: 8px;
  }

  .auth-debug {
    background: #f3f4f6;
    padding: 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 13px;
    text-align: left;
    font-family: 'Courier New', monospace;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }

  .auth-retry {
    margin-top: 24px;
  }

  .auth-retry a {
    color: #3b82f6;
    text-decoration: underline;
    font-weight: 500;
  }
</style>

<div class="auth-callback-container">
  <div class="auth-spinner" id="authSpinner"></div>
  <div class="auth-status" id="authStatus">✓ Добро пожаловать! Перенаправление, подождите немножко... (5)</div>
  <div class="auth-debug" id="authDebug"></div>
  <div class="auth-retry" id="authRetry" style="display: none;">
    <a href="/">Вернуться на главную</a>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════════════════
  // Safe localStorage wrapper (Safari Privacy Protection)
  // ═══════════════════════════════════════════════════════════

  const safeStorage = (function() {
    let memoryStorage = {}; // Fallback для Safari Privacy mode
    let storageAvailable = false;

    // Проверка доступности localStorage
    try {
      const testKey = '__storage_test__';
      localStorage.setItem(testKey, 'test');
      localStorage.removeItem(testKey);
      storageAvailable = true;
    } catch (e) {
      console.warn('⚠️  localStorage заблокирован Safari Privacy Protection, используем in-memory fallback');
      storageAvailable = false;
    }

    return {
      getItem: function(key) {
        try {
          return storageAvailable ? localStorage.getItem(key) : memoryStorage[key] || null;
        } catch (e) {
          return memoryStorage[key] || null;
        }
      },
      setItem: function(key, value) {
        try {
          if (storageAvailable) {
            localStorage.setItem(key, value);
          } else {
            memoryStorage[key] = value;
          }
        } catch (e) {
          memoryStorage[key] = value;
        }
      },
      removeItem: function(key) {
        try {
          if (storageAvailable) {
            localStorage.removeItem(key);
          } else {
            delete memoryStorage[key];
          }
        } catch (e) {
          delete memoryStorage[key];
        }
      }
    };
  })();

  // ═══════════════════════════════════════════════════════════
  // Configuration
  // ═══════════════════════════════════════════════════════════

  const CONFIG = {
    DEBUG_MODE: false,          // Set to true to see debug info
    THANK_YOU_PAGE: '/registr/', // Default thank you page for new users
    DEFAULT_REDIRECT: '/',       // Fallback for existing users
    NEW_USER_THRESHOLD: 60000    // 60 seconds to consider "new user"
  };

  // ═══════════════════════════════════════════════════════════
  // DOM Elements
  // ═══════════════════════════════════════════════════════════

  const spinner = document.getElementById('authSpinner');
  const status = document.getElementById('authStatus');
  const debugPanel = document.getElementById('authDebug');
  const retryPanel = document.getElementById('authRetry');

  // ═══════════════════════════════════════════════════════════
  // Utility Functions
  // ═══════════════════════════════════════════════════════════

  function debug(message, data = null) {
    console.log('[Auth Callback]', message, data || '');

    if (CONFIG.DEBUG_MODE) {
      debugPanel.style.display = 'block';
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      if (data) {
        line.textContent += ': ' + (typeof data === 'object' ? JSON.stringify(data) : data);
      }
      debugPanel.appendChild(line);
    }
  }

  function updateStatus(message, type = 'normal') {
    status.textContent = message;
    status.className = 'auth-status';

    if (type === 'success') {
      status.classList.add('success');
      spinner.style.display = 'none';
    } else if (type === 'error') {
      status.classList.add('error');
      spinner.style.display = 'none';
      retryPanel.style.display = 'block';
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Token Extraction
  // ═══════════════════════════════════════════════════════════

  function extractTokensFromHash() {
    debug('Extracting tokens from URL');
    debug('Current URL', window.location.href);
    debug('Hash fragment', window.location.hash);
    debug('Query string', window.location.search);

    let params;
    let source;

    // Try hash fragment first (Implicit flow)
    const hash = window.location.hash;
    if (hash && hash.includes('access_token=')) {
      params = new URLSearchParams(hash.substring(1));
      source = 'hash fragment (Implicit flow)';
    }
    // Fallback to query string (PKCE flow)
    else if (window.location.search && window.location.search.includes('access_token=')) {
      params = new URLSearchParams(window.location.search.substring(1));
      source = 'query string (PKCE flow)';
    }
    else {
      throw new Error('Токен аутентификации не найден в URL. Пожалуйста, нажмите на волшебную ссылку в письме.');
    }

    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const tokenType = params.get('token_type');

    if (!accessToken) {
      throw new Error('Токен доступа отсутствует в URL');
    }

    debug('Tokens extracted successfully from ' + source);
    debug('Access token preview', accessToken.substring(0, 20) + '...');

    return {
      access_token: accessToken,
      refresh_token: refreshToken,
      token_type: tokenType
    };
  }

  // ═══════════════════════════════════════════════════════════
  // WordPress Authentication
  // ═══════════════════════════════════════════════════════════

  async function authenticateWithWordPress(tokens) {
    debug('Calling WordPress REST API');

    const endpoint = window.location.origin + '/wp-json/supabase-bridge/v1/callback';
    debug('Endpoint', endpoint);

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          access_token: tokens.access_token,
          registration_url: safeStorage.getItem('registration_page_url') || window.location.pathname
        }),
        credentials: 'include' // CRITICAL: Include cookies
      });

      debug('Response status', response.status);

      const data = await response.json();
      debug('Response data', data);

      // Handle duplicate callback (another tab/window already processing)
      if (response.status === 409) {
        debug('Duplicate callback detected');
        updateStatus('Аутентификация уже выполняется в другом окне...');
        setTimeout(() => {
          window.location.href = CONFIG.DEFAULT_REDIRECT;
        }, 2000);
        return null;
      }

      // Handle error responses
      if (!response.ok) {
        throw new Error(data.message || `Ошибка аутентификации (HTTP ${response.status})`);
      }

      return data;

    } catch (error) {
      debug('WordPress API error', error.message);
      throw error;
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Redirect Logic
  // ═══════════════════════════════════════════════════════════

  function getRedirectUrl(wpResponse) {
    // ═══════════════════════════════════════════════════════════
    // PRIORITY-BASED REDIRECT LOGIC (v0.9.11)
    // ═══════════════════════════════════════════════════════════
    //
    // Priority 1: Backend set redirect_url (Registration Pairs)
    //   → User came from landing page form (e.g., /reg_ai_intro/)
    //   → Redirect to Thank You page (regardless of NEW vs EXISTING)
    //
    // Priority 2: Return URL (General Login)
    //   → User came from general login in menu (e.g., /test-no-elem/)
    //   → Return to page where they came from
    //
    // Priority 3: Default fallback
    //   → Home page or global default
    // ═══════════════════════════════════════════════════════════

    // PRIORITY 1: Check if backend set redirect_url (Registration Pairs)
    if (wpResponse && wpResponse.redirect_url) {
      // Backend found this form in Registration Pairs → Landing page scenario
      debug('✓ Backend set redirect_url (Landing Page Form)', wpResponse.redirect_url);
      debug('  → Redirecting to Thank You page (user came from targeted landing)');
      return wpResponse.redirect_url;
    }

    // PRIORITY 2: No redirect_url → General login scenario → Use Return URL
    // Read redirect_to parameter from URL query string
    const urlParams = new URLSearchParams(window.location.search);
    let redirectTo = urlParams.get('redirect_to');

    // Fallback: Read from localStorage (saved on login page)
    if (!redirectTo) {
      redirectTo = safeStorage.getItem('login_return_url');
    }

    if (redirectTo) {
      debug('✓ Using Return URL (General Login)', redirectTo);
      debug('  → User came from menu login, returning to origin page');
      return redirectTo;
    }

    // PRIORITY 3: Default fallback
    debug('✓ Using default redirect', CONFIG.DEFAULT_REDIRECT);
    debug('  → No specific redirect found, using global default');
    return CONFIG.DEFAULT_REDIRECT;
  }

  // ═══════════════════════════════════════════════════════════
  // Main Authentication Flow
  // ═══════════════════════════════════════════════════════════

  async function processAuthentication() {
    debug('Starting authentication process');

    // Update instant loader content instead of hiding it (avoid flickering)
    const instantLoader = document.getElementById('instant-loader');
    const instantLoaderContent = instantLoader ? instantLoader.querySelector('div') : null;

    if (instantLoaderContent) {
      // Replace loading dots with simple message
      instantLoaderContent.innerHTML = `
        <h2 style="color: #16a34a; font-size: 24px; margin: 0; font-weight: 600;">✓ Добро пожаловать!</h2>
        <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;" id="instant-status">Подождите немножко.</p>
      `;
    }

    // Animated dots (shows progress without specific timing)
    let dotCount = 1;
    const dotsTimer = setInterval(() => {
      dotCount = (dotCount % 5) + 1; // 1-5 dots cycle
      const dots = '.'.repeat(dotCount);
      const instantStatus = document.getElementById('instant-status');
      if (instantStatus) {
        instantStatus.textContent = `Подождите немножко${dots}`;
      }
    }, 400);

    try {
      // Step 1: Extract tokens from URL hash
      const tokens = extractTokensFromHash();

      // Step 2: Authenticate with WordPress
      const wpResponse = await authenticateWithWordPress(tokens);

      // Handle duplicate callback (null response)
      if (wpResponse === null) {
        clearInterval(dotsTimer);
        return;
      }

      // Step 3: Determine redirect URL
      const redirectUrl = getRedirectUrl(wpResponse);

      // Step 4: Success! Redirect user
      debug('Redirecting to', redirectUrl);

      // Clean localStorage (no longer needed after login)
      safeStorage.removeItem('login_return_url');
      safeStorage.removeItem('registration_page_url');
      debug('Cleaned localStorage (login_return_url, registration_page_url)');

      // Clean URL hash and redirect
      clearInterval(dotsTimer);

      setTimeout(() => {
        window.location.href = redirectUrl;
      }, 500);

    } catch (error) {
      console.error('[Auth Callback] Error:', error);
      debug('Authentication failed', error.toString());
      clearInterval(dotsTimer);
      updateStatus('⚠ Ошибка аутентификации: ' + error.message, 'error');
    }
  }

  // ═══════════════════════════════════════════════════════════
  // Initialize
  // ═══════════════════════════════════════════════════════════

  debug('Auth callback handler loaded');

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', processAuthentication);
  } else {
    processAuthentication();
  }

})();
</script>

<!--
  ═══════════════════════════════════════════════════════════════
  Installation Complete!

  This page will now:
  1. Extract Supabase tokens from URL hash
  2. Authenticate with WordPress REST API
  3. Create WordPress session
  4. Redirect based on user type:
     - EXISTING USER (login): Return to ?redirect_to= page or default
     - NEW USER (registration): Thank You page from Registration Pairs

  URL Parameters:
  - ?redirect_to=/premium-course/ → Returns existing user to that page

  Debug Mode:
  - Set CONFIG.DEBUG_MODE = true to see detailed logs
  - Check browser console for detailed information
  ═══════════════════════════════════════════════════════════════
-->
